<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EngVoca - ì˜ì–´ë‹¨ì–´ í•™ìŠµ</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&family=DM+Serif+Display&family=JetBrains+Mono:wght@400;600&family=Noto+Sans:wght@400;500&display=swap" rel="stylesheet">
<style>
:root{--bg:#f5f7fb;--surface:#ffffff;--surface2:#eef1f6;--accent:#5b6abf;--accent-light:#7c8ad9;--green:#2eaa7f;--red:#d9534f;--text:#2c2c3a;--text-dim:#7a8194;--card-radius:20px;--shadow:0 2px 12px rgba(0,0,0,.06)}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Noto Sans KR',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden}
body::before{content:'';position:fixed;top:-30%;left:-10%;width:60vw;height:60vw;background:radial-gradient(circle,rgba(91,106,191,.07) 0%,transparent 70%);pointer-events:none;z-index:0}
body::after{content:'';position:fixed;bottom:-20%;right:-10%;width:50vw;height:50vw;background:radial-gradient(circle,rgba(46,170,127,.05) 0%,transparent 70%);pointer-events:none;z-index:0}
.app{position:relative;z-index:1;max-width:520px;margin:0 auto;padding:20px 16px 40px}

.header{text-align:center;padding:24px 0 20px}
.header h1{font-family:'DM Serif Display',serif;font-size:2rem;letter-spacing:2px;background:linear-gradient(135deg,var(--accent),var(--green));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.header h1 span{font-family:'DM Serif Display',serif;font-size:1.4rem}
.header p{color:var(--text-dim);font-size:.85rem;margin-top:4px}

.loading{position:fixed;inset:0;z-index:300;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px}
.loading-logo{font-family:'DM Serif Display',serif;font-size:3rem;letter-spacing:3px;background:linear-gradient(135deg,var(--accent),var(--green));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.loading-sub{color:var(--text-dim);font-size:.9rem}
.loading-status{color:var(--accent);font-size:.82rem;margin-top:16px;min-height:1.2em}
.loading-bar{width:200px;height:4px;background:var(--surface2);border-radius:2px;overflow:hidden;margin-top:6px}
.loading-bar-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--green));border-radius:2px;transition:width .3s ease;width:0%}

/* â”€â”€ êµì¬ ì„ íƒ í™”ë©´ â”€â”€ */
.book-select-screen{display:none}
.book-select-title{font-size:1.1rem;font-weight:700;margin-bottom:16px;color:var(--text);text-align:center}
.book-grid{display:flex;flex-direction:column;gap:10px}
.book-card{padding:18px 16px;border:1px solid rgba(0,0,0,.08);border-radius:16px;background:var(--surface);cursor:pointer;transition:all .25s;box-shadow:var(--shadow)}
.book-card:hover{border-color:var(--accent);background:#f0f2ff}
.book-card:active{background:var(--accent);color:#fff;border-color:var(--accent)}
.book-card:active .book-days{color:#fff}
.book-name{font-weight:700;font-size:.95rem;margin-bottom:4px}
.book-days{font-size:.75rem;color:var(--text-dim)}

/* â”€â”€ Day ì„ íƒ í™”ë©´ â”€â”€ */
.day-select-screen{display:none}
.day-select-title{font-size:1rem;font-weight:700;margin-bottom:14px;color:var(--text)}
.day-grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(80px, 1fr));gap:8px}
.day-grid-btn{padding:10px 4px;border:1px solid rgba(0,0,0,.08);border-radius:14px;background:var(--surface);color:var(--text);font-family:'Noto Sans KR',sans-serif;font-size:.85rem;font-weight:600;cursor:pointer;transition:all .25s;box-shadow:var(--shadow);text-align:center}
.day-grid-btn:hover{border-color:var(--accent);color:var(--accent);background:#f0f2ff}
.day-grid-btn:active{background:var(--accent);color:#fff;border-color:var(--accent)}
.day-grid-btn.done{border-color:rgba(46,170,127,.3);background:rgba(46,170,127,.04)}
.day-grid-btn.done .day-num{color:var(--green)}
.day-bar-wrap{display:flex;align-items:center;gap:4px;margin:6px 6px 0;justify-content:center}
.day-bar{flex:1;height:4px;background:var(--surface2);border-radius:2px;overflow:hidden}
.day-bar-fill{height:100%;border-radius:2px;background:linear-gradient(90deg,var(--accent),var(--green))}
.day-pct{font-size:.55rem;color:var(--text-dim);font-weight:600;min-width:24px;text-align:right}
.book-change-wrap{margin-top:24px;padding-top:16px;border-top:1px solid rgba(0,0,0,.06);text-align:center}
.btn-change-book{background:rgba(91,106,191,.07);border:1px solid rgba(91,106,191,.2);border-radius:12px;padding:10px 24px;font-family:'Noto Sans KR',sans-serif;font-size:.82rem;color:var(--accent);cursor:pointer;transition:all .25s;font-weight:500}
.btn-change-book:hover{background:rgba(91,106,191,.13);border-color:var(--accent)}
.btn-change-book:active{background:var(--accent);color:#fff;border-color:var(--accent)}

/* â”€â”€ í•™ìŠµ í™”ë©´ â”€â”€ */
.study-screen{display:none}

.btn-back{display:none}
.header-day-link{cursor:pointer;color:var(--green);transition:opacity .2s}
.header-day-link:active{opacity:.6}

/* í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸ */
.confirm-overlay{display:none;position:fixed;inset:0;z-index:300;background:rgba(0,0,0,.3);backdrop-filter:blur(8px);align-items:center;justify-content:center}
.confirm-overlay.open{display:flex}
.confirm-box{background:var(--surface);border-radius:var(--card-radius);padding:28px 24px;width:90%;max-width:320px;text-align:center;box-shadow:0 8px 40px rgba(0,0,0,.12)}
.confirm-msg{font-size:.95rem;margin-bottom:20px;line-height:1.5}
.confirm-btns{display:flex;gap:10px}
.confirm-btns button{flex:1;padding:12px;border:none;border-radius:12px;font-family:'Noto Sans KR',sans-serif;font-size:.9rem;font-weight:500;cursor:pointer}
.confirm-yes{background:var(--accent);color:#fff}
.confirm-no{background:var(--surface2);color:var(--text)}

.day-title{text-align:left;font-size:.84rem;color:var(--accent);font-weight:500;margin-bottom:16px;padding:10px 16px;background:rgba(91,106,191,.06);border-radius:10px;line-height:1.5}
.day-title-grid{display:grid;grid-template-columns:auto 1fr auto 1fr;gap:2px 8px;align-items:baseline}
.day-title-en{color:var(--text);font-weight:700;white-space:nowrap}
.day-title-ko{color:var(--accent)}

/* Card */
.card-area{margin-bottom:16px}
.card-top-bar{position:absolute;top:16px;left:16px;right:16px;display:flex;justify-content:space-between;align-items:center;z-index:5}
.card-btn{width:40px;height:40px;border-radius:12px;border:1px solid rgba(0,0,0,.08);background:var(--surface);color:var(--text-dim);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;font-size:1.1rem;box-shadow:var(--shadow)}
.card-btn:hover{background:var(--surface2);color:var(--text)}
.card-btn.speaking{color:var(--accent);border-color:var(--accent);background:rgba(91,106,191,.08)}
.card-btn.starred{color:#f0a500;border-color:#f0a500;background:rgba(240,165,0,.08)}
.card-btn.mode-btn{width:auto;padding:0 12px;font-size:.75rem;font-weight:600;gap:4px;white-space:nowrap}
.card-flip-wrapper{perspective:1000px;width:100%}
.card-flip-inner{position:relative;width:100%;transition:transform .5s ease;transform-style:preserve-3d}
.card-flip-inner.flipped{transform:rotateY(180deg)}
.card-flip-inner.flipped .card-front{pointer-events:none}
.card-flip-inner.flipped .card-back{pointer-events:auto}
.card-front,.card-back{width:100%;min-height:340px;backface-visibility:hidden;-webkit-backface-visibility:hidden;border-radius:var(--card-radius);padding:60px 28px 32px;border:1px solid rgba(0,0,0,.06);box-shadow:var(--shadow);background:linear-gradient(145deg,#ffffff,#f0f3f8);display:flex;flex-direction:column;align-items:center;justify-content:flex-start;position:relative}
.card-back{position:absolute;top:0;left:0;transform:rotateY(180deg);background:linear-gradient(145deg,#f0f3f8,#ffffff);padding-bottom:40px;overflow-y:auto}
.card-mode-hint{font-size:.7rem;color:var(--text-dim);opacity:.5;text-align:center;margin-top:12px}
.card-front .card-mode-hint{position:absolute;bottom:12px;margin-top:0}
.card-etymology{width:100%;margin-top:16px;text-align:center}
.card-etymology .ety-parts{display:flex;justify-content:center;flex-wrap:wrap;gap:6px;margin-bottom:12px}
.card-etymology .ety-part{display:flex;flex-direction:column;align-items:center;padding:8px 12px;border-radius:10px;background:rgba(91,106,191,.06);border:1px solid rgba(91,106,191,.15)}
.card-etymology .ety-part .part-text{font-family:'DM Serif Display',serif;font-size:1.1rem;font-weight:600;color:var(--accent);letter-spacing:.5px}
.card-etymology .ety-part .part-mean{font-size:.7rem;color:var(--text-dim);margin-top:2px}
.card-etymology .ety-plus{display:flex;align-items:center;color:var(--text-dim);font-size:1rem;font-weight:700;padding:0 2px}
.card-etymology .ety-origin{font-size:.82rem;color:var(--text);line-height:1.5;padding:10px 14px;border-radius:10px;background:rgba(46,170,127,.05);border:1px solid rgba(46,170,127,.12)}

/* â”€â”€ Card Extras (ì˜ˆë¬¸, íŒŒìƒì–´, ë™ì˜ì–´, ìˆ™ì–´) â”€â”€ */
.card-extras{width:100%;margin-top:16px;text-align:left}
.extras-divider{height:1px;background:rgba(0,0,0,.06);margin:14px 0}
.extras-section-title{font-size:.75rem;font-weight:700;color:var(--text-dim);margin-bottom:8px;display:flex;align-items:center;gap:6px}
.example-item{margin-bottom:10px;padding:10px 14px;border-radius:10px;background:rgba(91,106,191,.04);border:1px solid rgba(91,106,191,.08)}
.example-item:last-child{margin-bottom:0}
.example-en{font-size:.83rem;color:var(--text);line-height:1.5;margin-bottom:3px}
.example-en b{color:var(--accent);font-weight:700}
.example-ko{font-size:.76rem;color:var(--text-dim);line-height:1.4}
.example-source{display:inline-block;font-size:.58rem;padding:2px 6px;border-radius:4px;background:var(--red);color:#fff;font-weight:600;margin-left:4px;vertical-align:middle}
.deriv-item{display:flex;align-items:baseline;gap:8px;margin-bottom:5px;font-size:.82rem}
.deriv-word{font-family:'DM Serif Display',serif;font-weight:600;color:var(--accent);min-width:85px}
.deriv-pos{font-size:.62rem;font-weight:700;color:#fff;background:var(--accent);padding:2px 7px;border-radius:10px;flex-shrink:0}
.deriv-def{color:var(--text)}
.syn-ant-row{display:flex;gap:8px;flex-wrap:wrap}
.syn-tag,.ant-tag{font-size:.78rem;padding:5px 11px;border-radius:8px}
.syn-tag{background:rgba(46,170,127,.08);border:1px solid rgba(46,170,127,.2);color:var(--green)}
.ant-tag{background:rgba(217,83,79,.08);border:1px solid rgba(217,83,79,.2);color:var(--red)}
.syn-label,.ant-label{font-size:.58rem;font-weight:700;margin-right:2px}
.phrase-item{font-size:.82rem;margin-bottom:4px;color:var(--text)}
.phrase-en{font-weight:600;color:var(--accent)}

/* ì•„ì½”ë””ì–¸ */
.acc-section{border:1px solid rgba(0,0,0,.06);border-radius:12px;margin-bottom:8px;overflow:hidden}
.acc-header{display:flex;align-items:center;justify-content:space-between;padding:11px 14px;cursor:pointer;background:var(--surface);transition:background .2s;font-size:.82rem;font-weight:600;color:var(--text);border:none;width:100%;text-align:left;font-family:'Noto Sans KR',sans-serif}
.acc-header:hover{background:var(--surface2)}
.acc-header .acc-icon{font-size:.7rem;transition:transform .3s;color:var(--text-dim)}
.acc-header.open .acc-icon{transform:rotate(180deg)}
.acc-body{max-height:0;overflow:hidden;transition:max-height .35s ease,padding .35s ease;padding:0 14px;background:var(--surface)}
.acc-body.open{max-height:600px;padding:12px 14px}

/* íƒ­ */
.extras-tab-bar{display:flex;gap:4px;margin-bottom:14px;padding:4px;background:var(--surface2);border-radius:12px}
.extras-tab-btn{flex:1;padding:9px 4px;border:none;border-radius:10px;font-family:'Noto Sans KR',sans-serif;font-size:.75rem;font-weight:600;cursor:pointer;color:var(--text-dim);background:transparent;transition:all .2s}
.extras-tab-btn.active{background:var(--surface);color:var(--accent);box-shadow:0 1px 4px rgba(0,0,0,.08)}
.extras-tab-content{display:none}
.extras-tab-content.active{display:block}
.card-word{font-family:'DM Serif Display',serif;font-size:2.6rem;letter-spacing:1px;text-align:center;margin-bottom:6px}
.card-ipa{font-size:.95rem;color:var(--text-dim);text-align:center;margin-bottom:20px;font-family:'Noto Sans',sans-serif}
.card-meanings{width:100%}
.meaning-group{width:100%;margin-bottom:10px}.meaning-group:last-child{margin-bottom:0}
.pos-tag{display:inline-block;background:var(--accent);color:#fff;font-size:.7rem;font-weight:700;padding:3px 10px;border-radius:20px;vertical-align:middle;margin-right:6px}
.def-inline{font-size:1rem;line-height:1.6;color:var(--text)}.def-highlight{color:#d32f2f;font-weight:700}.def-num{font-weight:700;margin-right:2px;color:var(--text)}.def-numbered{display:block;margin-left:40px}

/* Navigation */
.card-nav{display:flex;gap:8px;margin-bottom:12px}
.card-nav button{flex:1;padding:13px 4px;border:1px solid rgba(0,0,0,.06);border-radius:14px;font-family:'Noto Sans KR',sans-serif;font-size:.85rem;font-weight:500;cursor:pointer;transition:all .2s;background:var(--surface);color:var(--text);box-shadow:var(--shadow)}
.card-nav button:hover:not(:disabled){background:var(--accent);color:#fff;border-color:var(--accent)}
.card-nav button:disabled{opacity:.35;cursor:default;background:var(--surface2);color:var(--text-dim);border-color:rgba(0,0,0,.04);box-shadow:none}
.card-counter{text-align:center;font-size:.82rem;color:var(--text-dim);font-family:'JetBrains Mono',monospace}
.btn-quiz{width:100%;padding:14px;margin-top:8px;border:1px solid rgba(46,170,127,.3);border-radius:14px;background:rgba(46,170,127,.06);color:var(--green);font-family:'Noto Sans KR',sans-serif;font-size:.9rem;font-weight:600;cursor:pointer;transition:all .2s;box-shadow:var(--shadow)}
.btn-quiz:hover{background:var(--green);color:#fff;border-color:var(--green)}

/* Quiz */
.quiz-select-screen{display:none}
.quiz-select-title{font-size:1rem;font-weight:700;margin-bottom:14px;color:var(--text)}
.quiz-mode-list{display:flex;flex-direction:column;gap:10px}
.quiz-mode-btn{padding:16px 20px;border:1px solid rgba(0,0,0,.08);border-radius:14px;background:var(--surface);color:var(--text);font-family:'Noto Sans KR',sans-serif;font-size:.9rem;font-weight:500;cursor:pointer;transition:all .25s;box-shadow:var(--shadow);text-align:left;display:flex;align-items:center;gap:12px}
.quiz-mode-btn:hover{border-color:var(--accent);background:#f0f2ff}
.quiz-mode-btn:active{background:var(--accent);color:#fff;border-color:var(--accent)}
.quiz-mode-icon{font-size:1.3rem;width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.quiz-mode-icon.mc{background:rgba(91,106,191,.1)}
.quiz-mode-icon.write{background:rgba(46,170,127,.1)}
.quiz-mode-info{display:flex;flex-direction:column}
.quiz-mode-info span{font-size:.75rem;color:var(--text-dim);margin-top:2px}
.quiz-back-btn{margin-top:16px;width:100%;padding:12px;border:1px solid rgba(0,0,0,.08);border-radius:12px;background:var(--surface2);color:var(--text);font-family:'Noto Sans KR',sans-serif;font-size:.85rem;cursor:pointer;transition:all .2s}
.quiz-back-btn:hover{background:var(--accent);color:#fff;border-color:var(--accent)}

.quiz-screen{display:none}
.quiz-progress{display:flex;align-items:center;gap:8px;margin-bottom:16px}
.quiz-progress-bar{flex:1;height:6px;background:var(--surface2);border-radius:3px;overflow:hidden}
.quiz-progress-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--green));border-radius:3px;transition:width .3s ease}
.quiz-progress-text{font-size:.8rem;color:var(--text-dim);font-family:'JetBrains Mono',monospace;min-width:50px;text-align:right}

.quiz-card{width:100%;border-radius:var(--card-radius);padding:32px 24px;border:1px solid rgba(0,0,0,.06);box-shadow:var(--shadow);background:linear-gradient(145deg,#ffffff,#f0f3f8);text-align:center;margin-bottom:16px}
.quiz-label{font-size:.75rem;color:var(--text-dim);margin-bottom:8px;font-weight:500}
.quiz-question{font-size:1.8rem;font-weight:700;margin-bottom:4px}
.quiz-question.en{font-family:'DM Serif Display',serif;letter-spacing:1px}
.quiz-question.kr{font-size:1.2rem;line-height:1.6}
.quiz-ipa{font-size:.9rem;color:var(--text-dim);font-family:'Noto Sans',sans-serif}

.quiz-choices{display:flex;flex-direction:column;gap:8px;margin-bottom:12px}
.quiz-choice{padding:14px 18px;border:1.5px solid rgba(0,0,0,.08);border-radius:14px;background:var(--surface);color:var(--text);font-family:'Noto Sans KR',sans-serif;font-size:.92rem;cursor:pointer;transition:all .2s;box-shadow:var(--shadow);text-align:left}
.quiz-choice:hover{border-color:var(--accent);background:#f0f2ff}
.quiz-choice.correct{border-color:var(--green);background:rgba(46,170,127,.08);color:var(--green);font-weight:600}
.quiz-choice.wrong{border-color:var(--red);background:rgba(217,83,79,.08);color:var(--red)}
.quiz-choice.reveal{border-color:var(--green);background:rgba(46,170,127,.08);color:var(--green)}
.quiz-choice.disabled{pointer-events:none;opacity:.5}

.quiz-input-wrap{margin-bottom:12px}
.quiz-input{width:100%;padding:14px 18px;border:1.5px solid rgba(0,0,0,.12);border-radius:14px;font-family:'Noto Sans KR',sans-serif;font-size:1rem;color:var(--text);background:var(--surface);outline:none;transition:border-color .2s}
.quiz-input:focus{border-color:var(--accent)}
.quiz-input.correct{border-color:var(--green);background:rgba(46,170,127,.06)}
.quiz-input.wrong{border-color:var(--red);background:rgba(217,83,79,.06)}
.quiz-submit-btn{width:100%;padding:13px;border:none;border-radius:14px;background:var(--accent);color:#fff;font-family:'Noto Sans KR',sans-serif;font-size:.9rem;font-weight:600;cursor:pointer;transition:all .2s;margin-bottom:12px}
.quiz-submit-btn:hover{background:var(--accent-light)}
.quiz-submit-btn:disabled{background:var(--surface2);color:var(--text-dim);cursor:default}

.quiz-feedback{font-size:.85rem;min-height:1.4em;margin-bottom:8px;font-weight:500;text-align:center}
.quiz-feedback.correct{color:var(--green)}
.quiz-feedback.wrong{color:var(--red)}
.quiz-answer-reveal{font-size:.85rem;color:var(--text-dim);text-align:center;margin-bottom:8px}

.quiz-result-screen{display:none}
.quiz-result-card{width:100%;border-radius:var(--card-radius);padding:36px 24px;border:1px solid rgba(0,0,0,.06);box-shadow:var(--shadow);background:linear-gradient(145deg,#ffffff,#f0f3f8);text-align:center;margin-bottom:16px}
.quiz-result-emoji{font-size:3rem;margin-bottom:12px}
.quiz-result-title{font-size:1.3rem;font-weight:700;margin-bottom:6px}
.quiz-result-score{font-size:2.4rem;font-weight:900;background:linear-gradient(135deg,var(--accent),var(--green));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:4px}
.quiz-result-sub{font-size:.85rem;color:var(--text-dim)}
.quiz-result-wrong{text-align:left;margin-top:16px;padding-top:16px;border-top:1px solid rgba(0,0,0,.06)}
.quiz-result-wrong-title{font-size:.85rem;font-weight:600;color:var(--red);margin-bottom:10px}
.quiz-wrong-item{display:flex;justify-content:space-between;align-items:baseline;padding:8px 0;border-bottom:1px solid rgba(0,0,0,.04);font-size:.88rem}
.quiz-wrong-item .en{font-family:'DM Serif Display',serif;font-weight:600}
.quiz-wrong-item .kr{color:var(--text-dim)}
.quiz-result-btns{display:flex;flex-direction:column;gap:8px}
.quiz-result-btn{padding:14px;border:1px solid rgba(0,0,0,.08);border-radius:14px;background:var(--surface);color:var(--text);font-family:'Noto Sans KR',sans-serif;font-size:.9rem;font-weight:500;cursor:pointer;transition:all .2s;box-shadow:var(--shadow)}
.quiz-result-btn:hover{background:var(--accent);color:#fff;border-color:var(--accent)}
.quiz-result-btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
.quiz-result-btn.primary:hover{background:var(--accent-light)}

/* Settings */
.settings-toggle{position:fixed;top:16px;right:16px;z-index:100;width:40px;height:40px;border-radius:12px;background:var(--surface);border:1px solid rgba(0,0,0,.06);color:var(--text-dim);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;box-shadow:var(--shadow)}
.settings-toggle:hover{color:var(--text);background:var(--surface2)}
.settings-toggle svg{width:20px;height:20px}
.settings-panel{display:none;position:fixed;inset:0;z-index:200;background:rgba(0,0,0,.3);backdrop-filter:blur(8px);padding:20px;overflow-y:auto}
.settings-panel.open{display:flex;align-items:center;justify-content:center}
.settings-content{background:var(--surface);border-radius:var(--card-radius);padding:32px 24px;width:100%;max-width:460px;border:1px solid rgba(0,0,0,.08);box-shadow:0 8px 40px rgba(0,0,0,.12)}
.settings-title{font-size:1.2rem;font-weight:700;margin-bottom:20px}
.setting-row{display:flex;align-items:center;justify-content:space-between;padding:14px 0;border-bottom:1px solid rgba(0,0,0,.06)}
.setting-label{font-size:.9rem}
.setting-label span{display:block;font-size:.75rem;color:var(--text-dim);margin-top:2px}
.setting-select{background:var(--surface2);border:1px solid rgba(0,0,0,.08);border-radius:10px;padding:8px 14px;color:var(--text);font-family:'Noto Sans KR',sans-serif;font-size:.85rem}
.btn-close-settings{margin-top:20px;width:100%;padding:12px;background:var(--accent);color:#fff;border:none;border-radius:12px;font-family:'Noto Sans KR',sans-serif;font-size:.9rem;cursor:pointer}
.btn-reload{margin-top:10px;width:100%;padding:12px;background:var(--surface2);color:var(--text);border:1px solid rgba(0,0,0,.08);border-radius:12px;font-family:'Noto Sans KR',sans-serif;font-size:.85rem;cursor:pointer;transition:all .2s}
.btn-reload:hover{background:var(--accent);color:#fff;border-color:var(--accent)}

body.fullscreen-mode{overscroll-behavior-y:contain}
@keyframes fadeUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.fade-up{animation:fadeUp .4s ease both}

@media(max-width:400px){.card-word{font-size:2rem}.card-nav button{font-size:.78rem;padding:11px 2px}.day-grid{grid-template-columns:repeat(auto-fill, minmax(64px, 1fr));gap:6px}.day-grid-btn{padding:12px 2px;font-size:.8rem}}
</style>
</head>
<body>

<div class="confirm-overlay" id="confirmOverlay">
  <div class="confirm-box">
    <div class="confirm-msg">Day ì„ íƒ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ì‹œê² ìŠµë‹ˆê¹Œ?<br><span style="font-size:.8rem;color:var(--text-dim)">í•™ìŠµ ìœ„ì¹˜ëŠ” ì €ì¥ë©ë‹ˆë‹¤.</span></div>
    <div class="confirm-btns">
      <button class="confirm-yes" onclick="confirmGoBack()">ì˜ˆ</button>
      <button class="confirm-no" onclick="closeConfirm()">ì•„ë‹ˆì˜¤</button>
    </div>
  </div>
</div>

<button class="settings-toggle" onclick="toggleSettings()">
  <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 15a3 3 0 100-6 3 3 0 000 6z"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 01-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
</button>

<div class="settings-panel" id="settingsPanel">
  <div class="settings-content">
    <div class="settings-title">âš™ï¸ ì„¤ì •</div>
    <div class="setting-row">
      <div class="setting-label">ë‹¨ì–´ ìˆœì„œ<span>í•™ìŠµ ìˆœì„œ ì„¤ì •</span></div>
      <select class="setting-select" id="wordOrder">
        <option value="sequential" selected>ìˆœì„œëŒ€ë¡œ</option>
        <option value="random">ëœë¤</option>
      </select>
    </div>
    <div class="setting-row" style="flex-direction:column;align-items:stretch">
      <div class="setting-label" style="margin-bottom:8px">ë°œìŒ ëª©ì†Œë¦¬ (TTS ìŒì„± ì„ íƒ)</div>
      <select class="setting-select" id="voiceSelect" style="width:100%"></select>
    </div>
    <div class="setting-row">
      <div class="setting-label">ëŠë¦° ë°œìŒ ì†ë„<span>ë‘ ë²ˆì§¸ íƒ­ ì‹œ ì¬ìƒ ì†ë„</span></div>
      <select class="setting-select" id="slowSpeed">
        <option value="0.1">0.1x</option>
        <option value="0.2">0.2x</option>
        <option value="0.3">0.3x</option>
        <option value="0.4">0.4x</option>
        <option value="0.5" selected>0.5x</option>
        <option value="0.6">0.6x</option>
        <option value="0.7">0.7x</option>
      </select>
    </div>
    <div class="setting-row">
      <div class="setting-label">ì¹´ë“œ ë’·ë©´ ë ˆì´ì•„ì›ƒ<span>ì¶”ê°€ ì •ë³´ í‘œì‹œ ë°©ì‹</span></div>
      <select class="setting-select" id="cardLayout">
        <option value="scroll" selected>ëª¨ë‘ í¼ì¹˜ê¸°</option>
        <option value="accordion">ì ‘ì´ì‹</option>
        <option value="tab">íƒ­ ì „í™˜</option>
      </select>
    </div>
    <div class="setting-row">
      <div class="setting-label">ì¹´ë“œ ë„˜ê¹€ ì‹œ ë’¤ì§‘ê¸° ìƒíƒœ<span>ë‹¤ìŒ/ì´ì „ ì¹´ë“œ ì´ë™ ì‹œ</span></div>
      <select class="setting-select" id="keepFlip">
        <option value="reset" selected>ì•ë©´ìœ¼ë¡œ ì´ˆê¸°í™”</option>
        <option value="keep">í˜„ì¬ ìƒíƒœ ìœ ì§€</option>
      </select>
    </div>
    <button class="btn-reload" onclick="toggleFullscreen()" id="btnFullscreen">ğŸ–¥ï¸ ì „ì²´í™”ë©´ ëª¨ë“œ</button>
    <div style="font-size:.7rem;color:var(--text-dim);text-align:center;margin-top:4px">â€» iOS(ì•„ì´í°/ì•„ì´íŒ¨ë“œ)ì—ì„œëŠ” ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤</div>
    <button class="btn-reload" onclick="changeBook()">ğŸ“š êµì¬ ë³€ê²½</button>
    <button class="btn-reload" onclick="reloadDays()">ğŸ”„ Day íŒŒì¼ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
    <button class="btn-close-settings" onclick="closeSettings()">ë‹«ê¸°</button>
  </div>
</div>

<div class="app">
  <div class="header fade-up">
    <h1>EngVoca<span id="headerDayLabel" class="header-day-link" onclick="askGoBack()"></span></h1>
    <p>ì˜ì–´ë‹¨ì–´ í•™ìŠµ í”„ë¡œê·¸ë¨</p>
  </div>

  <div class="loading" id="loadingScreen" style="display:none">
    <div class="loading-logo">EngVoca</div>
    <div class="loading-sub">ì˜ì–´ë‹¨ì–´ í•™ìŠµ í”„ë¡œê·¸ë¨</div>
    <div class="loading-status" id="loadingStatus">ë°ì´í„° í™•ì¸ ì¤‘...</div>
    <div class="loading-bar"><div class="loading-bar-fill" id="loadingBarFill"></div></div>
  </div>

  <!-- êµì¬ ì„ íƒ í™”ë©´ -->
  <div class="book-select-screen" id="bookSelectScreen">
    <div class="book-select-title fade-up">ğŸ“š í•™ìŠµí•  êµì¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
    <div class="book-grid fade-up" style="animation-delay:.1s" id="bookGrid"></div>
  </div>

  <!-- Day ì„ íƒ í™”ë©´ -->
  <div class="day-select-screen" id="daySelectScreen">
    <div class="day-select-title fade-up">ğŸ“š í•™ìŠµí•  Dayë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
    <div class="day-grid fade-up" style="animation-delay:.1s" id="dayGrid"></div>
    <div class="book-change-wrap fade-up" style="animation-delay:.2s">
      <button class="btn-change-book" onclick="changeBook()">ğŸ“š êµì¬ ë³€ê²½</button>
    </div>
  </div>

  <!-- í•™ìŠµ í™”ë©´ -->
  <div class="study-screen" id="studyScreen">
    <div class="day-title" id="dayTitle" style="display:none"></div>

    <div class="card-area fade-up" style="animation-delay:.1s">
      <div class="card-flip-wrapper" id="cardFlipWrapper" onclick="flipCard(event)">
        <div class="card-flip-inner" id="cardFlipInner">
          <!-- ì•ë©´ -->
          <div class="card-front" id="cardFront">
            <div class="card-top-bar">
              <button class="card-btn" id="btnSpeak" onclick="speakWord(event)" title="ë°œìŒ ë“£ê¸°">ğŸ”Š</button>
              <button class="card-btn mode-btn" id="btnMode" onclick="cycleMode(event)" title="ë³´ê¸° ëª¨ë“œ ë³€ê²½">ğŸ“– ì „ì²´</button>
              <button class="card-btn" id="btnStar" onclick="toggleStar(event)" title="ì¤‘ìš” ë‹¨ì–´">â˜†</button>
            </div>
            <div class="card-word" id="cardWord">-</div>
            <div class="card-ipa" id="cardIpa"></div>
            <div class="card-meanings" id="cardMeanings"></div>
            <div class="card-mode-hint" id="frontHint"></div>
          </div>
          <!-- ë’·ë©´ -->
          <div class="card-back" id="cardBack">
            <div class="card-top-bar">
              <button class="card-btn" onclick="speakWord(event)" title="ë°œìŒ ë“£ê¸°">ğŸ”Š</button>
              <button class="card-btn mode-btn" onclick="cycleMode(event)" title="ë³´ê¸° ëª¨ë“œ ë³€ê²½" id="btnModeBack">ğŸ“– ì „ì²´</button>
              <button class="card-btn" onclick="toggleStar(event)" title="ì¤‘ìš” ë‹¨ì–´" id="btnStarBack">â˜†</button>
            </div>
            <div class="card-word" id="cardWordBack">-</div>
            <div class="card-ipa" id="cardIpaBack"></div>
            <div class="card-meanings" id="cardMeaningsBack"></div>
            <div class="card-etymology" id="cardEtymology"></div>
            <div class="card-extras" id="cardExtras"></div>
            <div class="card-mode-hint" id="backHint"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="card-nav fade-up" style="animation-delay:.15s">
      <button onclick="goFirst()" id="btnFirst">â—€â—€ ì²˜ìŒ</button>
      <button onclick="goPrev()" id="btnPrev">â—€ ì´ì „</button>
      <button onclick="goNext()" id="btnNext">ë‹¤ìŒ â–¶</button>
      <button onclick="goLast()" id="btnLast">ë â–¶â–¶</button>
    </div>

    <button class="btn-quiz" id="btnQuiz" onclick="startQuiz()" style="display:none">ğŸ“ í€´ì¦ˆ í’€ê¸°</button>
  </div>

  <!-- í€´ì¦ˆ ëª¨ë“œ ì„ íƒ -->
  <div class="quiz-select-screen" id="quizSelectScreen">
    <div class="quiz-select-title fade-up">ğŸ“ í€´ì¦ˆ ëª¨ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
    <div class="quiz-mode-list fade-up" style="animation-delay:.1s">
      <div class="quiz-mode-btn" onclick="beginQuiz('en2kr_mc')">
        <div class="quiz-mode-icon mc">ğŸ”¤</div>
        <div class="quiz-mode-info">ì˜ì–´ â†’ í•œê¸€ (4ì§€ì„ ë‹¤)<span>ì˜ì–´ ë‹¨ì–´ë¥¼ ë³´ê³  ëœ» ë§ì¶”ê¸°</span></div>
      </div>
      <div class="quiz-mode-btn" onclick="beginQuiz('kr2en_mc')">
        <div class="quiz-mode-icon mc">ğŸ‡°ğŸ‡·</div>
        <div class="quiz-mode-info">í•œê¸€ â†’ ì˜ì–´ (4ì§€ì„ ë‹¤)<span>í•œêµ­ì–´ ëœ»ì„ ë³´ê³  ë‹¨ì–´ ë§ì¶”ê¸°</span></div>
      </div>
      <div class="quiz-mode-btn" onclick="beginQuiz('en2kr_write')">
        <div class="quiz-mode-icon write">âœï¸</div>
        <div class="quiz-mode-info">ì˜ì–´ â†’ í•œê¸€ (ì£¼ê´€ì‹)<span>ì˜ì–´ ë‹¨ì–´ë¥¼ ë³´ê³  ëœ» ì§ì ‘ ì“°ê¸°</span></div>
      </div>
      <div class="quiz-mode-btn" onclick="beginQuiz('kr2en_write')">
        <div class="quiz-mode-icon write">âœï¸</div>
        <div class="quiz-mode-info">í•œê¸€ â†’ ì˜ì–´ (ì£¼ê´€ì‹)<span>í•œêµ­ì–´ ëœ»ì„ ë³´ê³  ë‹¨ì–´ ì§ì ‘ ì“°ê¸°</span></div>
      </div>
      <div class="quiz-mode-btn" onclick="openWrongNoteQuiz()" id="btnWrongNote" style="border-color:rgba(217,83,79,.2);background:rgba(217,83,79,.03)">
        <div class="quiz-mode-icon" style="background:rgba(217,83,79,.1)">ğŸ“‹</div>
        <div class="quiz-mode-info">ì˜¤ë‹µë…¸íŠ¸<span id="wrongNoteCount">í‹€ë¦° ë‹¨ì–´ ëª¨ì•„ì„œ ë‹¤ì‹œ í’€ê¸°</span></div>
      </div>
    </div>
    <button class="quiz-back-btn" onclick="exitQuiz()">â† í•™ìŠµìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
  </div>

  <!-- ì˜¤ë‹µë…¸íŠ¸ ëª¨ë“œ ì„ íƒ -->
  <div class="quiz-select-screen" id="wrongNoteSelectScreen">
    <div class="quiz-select-title fade-up">ğŸ“‹ ì˜¤ë‹µë…¸íŠ¸ â€” í€´ì¦ˆ ëª¨ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
    <div class="quiz-mode-list fade-up" style="animation-delay:.1s">
      <div class="quiz-mode-btn" id="wnBtn_en2kr_mc" onclick="beginWrongNoteQuiz('en2kr_mc')">
        <div class="quiz-mode-icon mc">ğŸ”¤</div>
        <div class="quiz-mode-info">ì˜ì–´ â†’ í•œê¸€ (4ì§€ì„ ë‹¤)<span>ì˜¤ë‹µ <strong id="wnCount_en2kr_mc">0ê°œ</strong></span></div>
      </div>
      <div class="quiz-mode-btn" id="wnBtn_kr2en_mc" onclick="beginWrongNoteQuiz('kr2en_mc')">
        <div class="quiz-mode-icon mc">ğŸ‡°ğŸ‡·</div>
        <div class="quiz-mode-info">í•œê¸€ â†’ ì˜ì–´ (4ì§€ì„ ë‹¤)<span>ì˜¤ë‹µ <strong id="wnCount_kr2en_mc">0ê°œ</strong></span></div>
      </div>
      <div class="quiz-mode-btn" id="wnBtn_en2kr_write" onclick="beginWrongNoteQuiz('en2kr_write')">
        <div class="quiz-mode-icon write">âœï¸</div>
        <div class="quiz-mode-info">ì˜ì–´ â†’ í•œê¸€ (ì£¼ê´€ì‹)<span>ì˜¤ë‹µ <strong id="wnCount_en2kr_write">0ê°œ</strong></span></div>
      </div>
      <div class="quiz-mode-btn" id="wnBtn_kr2en_write" onclick="beginWrongNoteQuiz('kr2en_write')">
        <div class="quiz-mode-icon write">âœï¸</div>
        <div class="quiz-mode-info">í•œê¸€ â†’ ì˜ì–´ (ì£¼ê´€ì‹)<span>ì˜¤ë‹µ <strong id="wnCount_kr2en_write">0ê°œ</strong></span></div>
      </div>
    </div>
    <button class="quiz-back-btn" onclick="closeWrongNoteSelect()">â† í€´ì¦ˆ ëª¨ë“œ ì„ íƒìœ¼ë¡œ</button>
  </div>

  <!-- í€´ì¦ˆ ì§„í–‰ -->
  <div class="quiz-screen" id="quizScreen">
    <div class="quiz-progress">
      <div class="quiz-progress-bar"><div class="quiz-progress-fill" id="quizProgressFill"></div></div>
      <div class="quiz-progress-text" id="quizProgressText">1 / 25</div>
    </div>
    <div class="quiz-card">
      <div class="quiz-label" id="quizLabel"></div>
      <div class="quiz-question" id="quizQuestion"></div>
      <div class="quiz-ipa" id="quizIpa"></div>
    </div>
    <div class="quiz-feedback" id="quizFeedback"></div>
    <div class="quiz-answer-reveal" id="quizAnswerReveal"></div>
    <div class="quiz-choices" id="quizChoices"></div>
    <div class="quiz-input-wrap" id="quizInputWrap" style="display:none">
      <input class="quiz-input" id="quizInput" type="text" placeholder="" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
    </div>
    <button class="quiz-submit-btn" id="quizSubmitBtn" onclick="submitWriteAnswer()" style="display:none">í™•ì¸</button>
  </div>

  <!-- í€´ì¦ˆ ê²°ê³¼ -->
  <div class="quiz-result-screen" id="quizResultScreen">
    <div class="quiz-result-card">
      <div class="quiz-result-emoji" id="quizResultEmoji">ğŸ‰</div>
      <div class="quiz-result-title" id="quizResultTitle"></div>
      <div class="quiz-result-score" id="quizResultScore"></div>
      <div class="quiz-result-sub" id="quizResultSub"></div>
      <div class="quiz-result-wrong" id="quizResultWrong" style="display:none">
        <div class="quiz-result-wrong-title" id="quizResultWrongTitle"></div>
        <div id="quizResultWrongList"></div>
      </div>
    </div>
    <div class="quiz-result-btns">
      <button class="quiz-result-btn primary" id="btnRetryWrong" onclick="retryWrongOnly()" style="display:none">âŒ í‹€ë¦° ë‹¨ì–´ë§Œ ë‹¤ì‹œ í’€ê¸°</button>
      <button class="quiz-result-btn" onclick="exitQuiz()">ğŸ“š í•™ìŠµìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
      <button class="quiz-result-btn" onclick="exitQuizToDay()">ğŸ  Day ì„ íƒìœ¼ë¡œ</button>
    </div>
  </div>
</div>

<script>
let dayData = [];
let allWords = [];
let studyWords = [];
let currentDayIndex = 0;
let currentIndex = 0;
let speakCount = 0;
let viewMode = 'all'; // 'all', 'en', 'kr'
let isFlipped = false;
let currentBook = null; // { id, name, days }

const VIEW_MODES = ['all', 'en', 'kr'];
const VIEW_LABELS = { all: 'ğŸ“– ì „ì²´', en: 'ğŸ”¤ ì˜ì–´', kr: 'ğŸ‡°ğŸ‡· í•œê¸€' };

// â”€â”€ íš¨ê³¼ìŒ ì‹œìŠ¤í…œ â”€â”€
let audioCtx;
function getAudioCtx() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if (audioCtx.state === 'suspended') audioCtx.resume();
  return audioCtx;
}

function playSound(type) {
  try {
    const ctx = getAudioCtx();
    const t = ctx.currentTime;

    if (type === 'daySelect') {
      // 4. ë²„ë¸” â€” Day ì„ íƒ
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = 'sine';
      osc.frequency.setValueAtTime(900, t);
      osc.frequency.exponentialRampToValueAtTime(300, t + 0.06);
      gain.gain.setValueAtTime(0.3, t);
      gain.gain.exponentialRampToValueAtTime(0.001, t + 0.06);
      osc.connect(gain); gain.connect(ctx.destination);
      osc.start(t); osc.stop(t + 0.06);
    }

    if (type === 'flip') {
      // 7. ì¹´ë“œ ë’¤ì§‘ê¸°
      const bufSize = ctx.sampleRate * 0.08;
      const buf = ctx.createBuffer(1, bufSize, ctx.sampleRate);
      const data = buf.getChannelData(0);
      for (let i = 0; i < bufSize; i++) {
        const progress = i / bufSize;
        const envelope = Math.sin(progress * Math.PI);
        data[i] = (Math.random() * 2 - 1) * envelope * 0.15;
      }
      const src = ctx.createBufferSource();
      const gain = ctx.createGain();
      const filter = ctx.createBiquadFilter();
      filter.type = 'highpass';
      filter.frequency.setValueAtTime(2000, t);
      filter.frequency.linearRampToValueAtTime(6000, t + 0.08);
      src.buffer = buf;
      gain.gain.setValueAtTime(0.3, t);
      src.connect(filter); filter.connect(gain); gain.connect(ctx.destination);
      src.start(t);
    }

    if (type === 'nav') {
      // 1. ê°€ë²¼ìš´ í´ë¦­ â€” ë„¤ë¹„ê²Œì´ì…˜
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = 'sine';
      osc.frequency.value = 800;
      gain.gain.setValueAtTime(0.3, t);
      gain.gain.exponentialRampToValueAtTime(0.001, t + 0.03);
      osc.connect(gain); gain.connect(ctx.destination);
      osc.start(t); osc.stop(t + 0.03);
    }

    if (type === 'speak') {
      // 3. ë†’ì€ í‹± â€” ìŠ¤í”¼ì»¤ ë²„íŠ¼
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = 'sine';
      osc.frequency.value = 1200;
      gain.gain.setValueAtTime(0.2, t);
      gain.gain.exponentialRampToValueAtTime(0.001, t + 0.02);
      osc.connect(gain); gain.connect(ctx.destination);
      osc.start(t); osc.stop(t + 0.02);
    }

    if (type === 'star') {
      // 6. ì†Œí”„íŠ¸ ë²¨ â€” ì¤‘ìš”ë‹¨ì–´ ì²´í¬
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = 'sine';
      osc.frequency.value = 880;
      gain.gain.setValueAtTime(0.15, t);
      gain.gain.exponentialRampToValueAtTime(0.001, t + 0.1);
      osc.connect(gain); gain.connect(ctx.destination);
      osc.start(t); osc.stop(t + 0.1);
    }

    if (type === 'settings') {
      // 5. íƒ­ â€” ì˜µì…˜ ë²„íŠ¼
      const bufSize = ctx.sampleRate * 0.025;
      const buf = ctx.createBuffer(1, bufSize, ctx.sampleRate);
      const data = buf.getChannelData(0);
      for (let i = 0; i < bufSize; i++) {
        data[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / bufSize, 8);
      }
      const src = ctx.createBufferSource();
      const gain = ctx.createGain();
      const filter = ctx.createBiquadFilter();
      filter.type = 'bandpass';
      filter.frequency.value = 3000;
      filter.Q.value = 0.8;
      src.buffer = buf;
      gain.gain.setValueAtTime(0.25, t);
      src.connect(filter); filter.connect(gain); gain.connect(ctx.destination);
      src.start(t);
    }

    if (type === 'mode') {
      // 2. ë¶€ë“œëŸ¬ìš´ íŒ â€” ëª¨ë“œ ì „í™˜
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = 'sine';
      osc.frequency.setValueAtTime(600, t);
      osc.frequency.exponentialRampToValueAtTime(400, t + 0.05);
      gain.gain.setValueAtTime(0.25, t);
      gain.gain.exponentialRampToValueAtTime(0.001, t + 0.05);
      osc.connect(gain); gain.connect(ctx.destination);
      osc.start(t); osc.stop(t + 0.05);
    }
  } catch(e) {}
}

function cycleMode(e) {
  if (e) { e.stopPropagation(); }
  playSound('mode');
  const idx = VIEW_MODES.indexOf(viewMode);
  viewMode = VIEW_MODES[(idx + 1) % VIEW_MODES.length];
  updateModeButtons();
  isFlipped = false;
  document.getElementById('cardFlipInner').classList.remove('flipped');
  showCard();
}

function updateModeButtons() {
  const counter = studyWords.length > 0 ? ` ${currentIndex + 1}/${studyWords.length}` : '';
  document.getElementById('btnMode').textContent = VIEW_LABELS[viewMode] + counter;
  document.getElementById('btnModeBack').textContent = VIEW_LABELS[viewMode] + counter;
}

function flipCard(e) {
  // ë²„íŠ¼ í´ë¦­ ì‹œ ë’¤ì§‘ê¸° ë°©ì§€
  if (e && e.target.closest('.card-btn')) return;
  if (e && e.target.closest('.card-extras')) return;
  // ì „ì²´ ëª¨ë“œì—ì„œ parts/extras ë°ì´í„° ì—†ìœ¼ë©´ ë’¤ì§‘ê¸° ì•ˆ í•¨
  if (viewMode === 'all') {
    const word = studyWords[currentIndex];
    if (!word || ((!word.parts || word.parts.length === 0) && !hasExtras(word))) return;
  }
  playSound('flip');
  isFlipped = !isFlipped;
  document.getElementById('cardFlipInner').classList.toggle('flipped', isFlipped);
  if (isFlipped) {
    updateCardHeight();
  } else {
    document.getElementById('cardFlipInner').style.minHeight = '';
  }
}

function resetFlip() {
  isFlipped = false;
  document.getElementById('cardFlipInner').classList.remove('flipped');
}

// ì¤‘ìš” ë‹¨ì–´
function getStarredWords() {
  try { return JSON.parse(localStorage.getItem(storageKey('starred')) || '[]'); } catch { return []; }
}
function saveStarredWords(arr) { localStorage.setItem(storageKey('starred'), JSON.stringify(arr)); }
function isStarred(word) { return getStarredWords().includes(word); }

// TTS ìŒì„±
let voices = [];
let voiceLoadAttempts = 0;
function loadVoices() {
  const allVoices = speechSynthesis.getVoices();
  voices = allVoices.filter(v => /^en[-_]/i.test(v.lang));
  const sel = document.getElementById('voiceSelect');
  sel.innerHTML = '';
  const defaultOpt = document.createElement('option');
  defaultOpt.value = '-1';
  defaultOpt.textContent = 'ğŸ“± ê¸°ê¸° ê¸°ë³¸ ìŒì„±';
  sel.appendChild(defaultOpt);
  voices.forEach((v, i) => {
    const opt = document.createElement('option');
    const female = /Female|female|Samantha|Victoria|Zira|Hazel|Susan|Karen|Moira|Fiona/i.test(v.name);
    const male = /Male|male|Daniel|David|Mark|Alex|Fred|Tom|James/i.test(v.name);
    opt.value = i;
    opt.textContent = `${female ? 'ğŸ‘© ' : male ? 'ğŸ‘¨ ' : ''}${v.name} (${v.lang})`;
    sel.appendChild(opt);
  });
  // ì €ì¥ëœ ìŒì„± ë³µì›
  const savedVoiceName = localStorage.getItem('engvoca_voice');
  if (savedVoiceName) {
    const idx = voices.findIndex(v => v.name === savedVoiceName);
    if (idx >= 0) sel.value = idx;
  }
  if (voices.length === 0 && voiceLoadAttempts < 10) {
    voiceLoadAttempts++;
    setTimeout(loadVoices, 300);
  }
}
if (typeof speechSynthesis !== 'undefined') {
  speechSynthesis.onvoiceschanged = loadVoices;
  loadVoices();
}

// ì„¤ì • ì €ì¥/ë³µì›
function saveSettings() {
  localStorage.setItem('engvoca_wordOrder', document.getElementById('wordOrder').value);
  localStorage.setItem('engvoca_slowSpeed', document.getElementById('slowSpeed').value);
  localStorage.setItem('engvoca_cardLayout', document.getElementById('cardLayout').value);
  localStorage.setItem('engvoca_keepFlip', document.getElementById('keepFlip').value);
  const vIdx = parseInt(document.getElementById('voiceSelect').value);
  if (vIdx >= 0 && voices[vIdx]) {
    localStorage.setItem('engvoca_voice', voices[vIdx].name);
  } else {
    localStorage.removeItem('engvoca_voice');
  }
}
function restoreSettings() {
  const savedOrder = localStorage.getItem('engvoca_wordOrder');
  if (savedOrder) document.getElementById('wordOrder').value = savedOrder;
  const savedSpeed = localStorage.getItem('engvoca_slowSpeed');
  if (savedSpeed) document.getElementById('slowSpeed').value = savedSpeed;
  const savedLayout = localStorage.getItem('engvoca_cardLayout');
  if (savedLayout) document.getElementById('cardLayout').value = savedLayout;
  const savedKeepFlip = localStorage.getItem('engvoca_keepFlip');
  if (savedKeepFlip) document.getElementById('keepFlip').value = savedKeepFlip;
  // ìŒì„±ì€ loadVoicesì—ì„œ ë³µì›
}
restoreSettings();
function getSelectedVoice() {
  const idx = parseInt(document.getElementById('voiceSelect').value);
  if (idx < 0 || isNaN(idx)) return null;
  return voices[idx] || null;
}

function speakWord(e) {
  if (e) { e.stopPropagation(); }
  playSound('speak');
  const word = studyWords[currentIndex]; if (!word) return;
  const btn = document.getElementById('btnSpeak');
  const synth = window.speechSynthesis; synth.cancel();
  const utter = new SpeechSynthesisUtterance(word.en);
  utter.lang = 'en-US';
  const voice = getSelectedVoice();
  if (voice) utter.voice = voice;
  if (speakCount === 0) { utter.rate = 1.0; speakCount = 1; }
  else { utter.rate = parseFloat(document.getElementById('slowSpeed').value) || 0.5; speakCount = 0; }
  btn.classList.add('speaking');
  utter.onend = () => btn.classList.remove('speaking');
  utter.onerror = () => btn.classList.remove('speaking');
  setTimeout(() => btn.classList.remove('speaking'), 3000);
  synth.speak(utter);
}

function toggleStar(e) {
  if (e) { e.stopPropagation(); }
  playSound('star');
  const word = studyWords[currentIndex]; if (!word) return;
  let starred = getStarredWords();
  const btn = document.getElementById('btnStar');
  if (starred.includes(word.en)) {
    starred = starred.filter(w => w !== word.en);
    btn.textContent = 'â˜†'; btn.classList.remove('starred');
  } else {
    starred.push(word.en);
    btn.textContent = 'â˜…'; btn.classList.add('starred');
  }
  saveStarredWords(starred);
}

// ë‚´ì¥ ê¸°ë³¸ ë°ì´í„°
const embeddedDays = [
  {"day":1,"title":"pro-/pre-, in-, out-/ut-/il-","words":[{"en":"progress","ipa":"/ËˆprÉ‘ËÉ¡res/","meanings":[{"pos":"ëª…","defs":["ì§„ë³´, ë°œì „"]},{"pos":"ë™","defs":["ì „ì§„í•˜ë‹¤, ë°œë‹¬í•˜ë‹¤"]}]},{"en":"propose","ipa":"/prÉ™ËˆpoÊŠz/","meanings":[{"pos":"ë™","defs":["ì œì•ˆí•˜ë‹¤","(ê²°í˜¼ì„) ì‹ ì²­í•˜ë‹¤"]}]}]}
];

// Day ë¡œë“œ (ë²„ì „ ì²´í¬ + ìºì‹œ)
function setLoadingStatus(text, pct) {
  document.getElementById('loadingStatus').textContent = text;
  document.getElementById('loadingBarFill').style.width = pct + '%';
}

// â”€â”€ localStorage í‚¤ í—¬í¼ (êµì¬ë³„ ë¶„ë¦¬) â”€â”€
function storageKey(key) {
  const prefix = currentBook ? currentBook.id : '00';
  return 'engvoca_' + prefix + '_' + key;
}

// â”€â”€ êµì¬ ì„ íƒ â”€â”€
async function loadBooks() {
  try {
    const res = await fetch('books/books.json?t=' + Date.now());
    if (res.ok) return await res.json();
  } catch (e) {}
  return [];
}

function showBookSelectScreen() {
  document.getElementById('bookSelectScreen').style.display = 'block';
  document.getElementById('daySelectScreen').style.display = 'none';
  document.getElementById('studyScreen').style.display = 'none';
  document.getElementById('quizSelectScreen').style.display = 'none';
  document.getElementById('quizScreen').style.display = 'none';
  document.getElementById('quizResultScreen').style.display = 'none';
  document.getElementById('wrongNoteSelectScreen').style.display = 'none';
  document.getElementById('headerDayLabel').textContent = '';
}

async function renderBookSelect(books) {
  showBookSelectScreen();
  const grid = document.getElementById('bookGrid');
  grid.innerHTML = '';
  books.forEach(b => {
    const card = document.createElement('div');
    card.className = 'book-card';
    card.innerHTML = '<div class="book-name">ğŸ“– ' + b.name + '</div><div class="book-days">Day 1 ~ Day ' + b.days + ' (' + b.days + 'ì¼)</div>';
    card.onclick = () => selectBook(b);
    grid.appendChild(card);
  });
}

async function selectBook(book) {
  playSound('daySelect');
  currentBook = book;
  localStorage.setItem('engvoca_currentBook', JSON.stringify(book));
  await loadAllDays();
}

function changeBook() {
  playSound('settings');
  closeSettings();
  localStorage.removeItem('engvoca_currentBook');
  currentBook = null;
  appInit();
}

// â”€â”€ ì•± ì‹œì‘ â”€â”€
async function appInit() {
  const books = await loadBooks();
  if (books.length === 0) {
    // books.json ì—†ìœ¼ë©´ ê¸°ì¡´ ë°©ì‹ fallback
    currentBook = { id: '00', name: '', days: 99 };
    await loadAllDays();
    return;
  }
  // ì €ì¥ëœ êµì¬ í™•ì¸
  const saved = localStorage.getItem('engvoca_currentBook');
  if (saved) {
    try {
      const savedBook = JSON.parse(saved);
      // books ëª©ë¡ì— ì•„ì§ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
      const found = books.find(b => b.id === savedBook.id);
      if (found) {
        currentBook = found;
        await loadAllDays();
        return;
      }
    } catch (e) {}
  }
  // ì €ì¥ëœ êµì¬ ì—†ìœ¼ë©´ êµì¬ ì„ íƒ í™”ë©´
  await renderBookSelect(books);
}

async function loadAllDays() {
  document.getElementById('loadingScreen').style.display = 'flex';
  document.getElementById('bookSelectScreen').style.display = 'none';
  document.getElementById('daySelectScreen').style.display = 'none';
  document.getElementById('studyScreen').style.display = 'none';
  dayData = []; allWords = [];

  const basePath = currentBook && currentBook.id !== '00' ? 'books/' + currentBook.id + '/' : '';

  setLoadingStatus('ë²„ì „ í™•ì¸ ì¤‘...', 10);

  let needFetch = true;
  try {
    const vRes = await fetch(basePath + 'version.json?t=' + Date.now());
    if (vRes.ok) {
      const vData = await vRes.json();
      const remoteKey = vData.version + '-' + vData.count;
      const localKey = localStorage.getItem(storageKey('version')) || '';
      const cached = localStorage.getItem(storageKey('daydata'));
      if (remoteKey === localKey && cached) {
        setLoadingStatus('ì €ì¥ëœ ë°ì´í„° ë¡œë“œ ì¤‘...', 80);
        dayData = JSON.parse(cached);
        needFetch = false;
      } else {
        setLoadingStatus('ìƒˆ ë°ì´í„° ë‹¤ìš´ë¡œë“œ ì¤‘...', 20);
        let dayNum = 1;
        while (true) {
          try {
            const dayStr = String(dayNum).padStart(2, '0');
            const res = await fetch(basePath + 'day' + dayStr + '.json?t=' + Date.now());
            if (!res.ok) break;
            const data = await res.json();
            dayData.push({ day: dayNum, title: data.title || '', words: data.words || [] });
            setLoadingStatus('ë‹¤ìš´ë¡œë“œ ì¤‘... Day ' + dayNum, 20 + Math.min(dayNum * 2, 60));
            dayNum++;
          } catch (e) { break; }
        }
        if (dayData.length > 0) {
          setLoadingStatus('ë°ì´í„° ì €ì¥ ì¤‘...', 90);
          localStorage.setItem(storageKey('daydata'), JSON.stringify(dayData));
          localStorage.setItem(storageKey('version'), remoteKey);
        }
        needFetch = false;
      }
    }
  } catch (e) {
    const cached = localStorage.getItem(storageKey('daydata'));
    if (cached) {
      setLoadingStatus('ì˜¤í”„ë¼ì¸ ëª¨ë“œ â€” ì €ì¥ëœ ë°ì´í„° ì‚¬ìš©', 80);
      dayData = JSON.parse(cached);
      needFetch = false;
    }
  }

  if (needFetch) {
    setLoadingStatus('Day íŒŒì¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...', 20);
    let dayNum = 1;
    while (true) {
      try {
        const dayStr = String(dayNum).padStart(2, '0');
        const res = await fetch(basePath + 'day' + dayStr + '.json');
        if (!res.ok) break;
        const data = await res.json();
        dayData.push({ day: dayNum, title: data.title || '', words: data.words || [] });
        setLoadingStatus('ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘... Day ' + dayNum, 20 + Math.min(dayNum * 2, 60));
        dayNum++;
      } catch (e) { break; }
    }
  }

  if (dayData.length === 0) dayData = embeddedDays;
  allWords = []; dayData.forEach(d => { allWords = allWords.concat(d.words); });
  setLoadingStatus('ì™„ë£Œ!', 100);
  await new Promise(r => setTimeout(r, 400));
  document.getElementById('loadingScreen').style.display = 'none';
  showDaySelectScreen();
}

async function reloadDays() {
  playSound('settings');
  toggleSettings();
  localStorage.removeItem(storageKey('version'));
  localStorage.removeItem(storageKey('daydata'));
  await loadAllDays();
}

// Day ì„ íƒ í™”ë©´
function showDaySelectScreen() {
  document.getElementById('bookSelectScreen').style.display = 'none';
  document.getElementById('daySelectScreen').style.display = 'block';
  document.getElementById('studyScreen').style.display = 'none';
  document.getElementById('quizSelectScreen').style.display = 'none';
  document.getElementById('quizScreen').style.display = 'none';
  document.getElementById('quizResultScreen').style.display = 'none';
  document.getElementById('wrongNoteSelectScreen').style.display = 'none';
  const titleEl = document.querySelector('.day-select-title');
  if (currentBook && currentBook.name) {
    titleEl.textContent = 'ğŸ“š ' + currentBook.name;
  } else {
    titleEl.textContent = 'ğŸ“š í•™ìŠµí•  Dayë¥¼ ì„ íƒí•˜ì„¸ìš”';
  }
  const grid = document.getElementById('dayGrid');
  grid.innerHTML = '';
  const positions = getSavedPositions();
  dayData.forEach((d, i) => {
    const btn = document.createElement('div');
    const savedPos = positions['day' + d.day] || 0;
    const total = d.words.length;
    const hasStarted = positions.hasOwnProperty('day' + d.day);
    const completed = isDayCompleted(d.day);
    const pct = completed ? 100 : (!hasStarted || total === 0) ? 0 : Math.round(((savedPos + 1) / total) * 100);
    const isDone = completed;
    btn.className = 'day-grid-btn' + (isDone ? ' done' : '');
    btn.innerHTML = `<div class="day-num">Day ${d.day}${isDone ? ' âœ“' : ''}</div><div class="day-bar-wrap"><div class="day-bar"><div class="day-bar-fill" style="width:${pct}%"></div></div><div class="day-pct">${pct}%</div></div>`;
    btn.onclick = () => enterStudy(i);
    grid.appendChild(btn);
  });
}

// í•™ìŠµ í™”ë©´ ì§„ì…
function enterStudy(index) {
  playSound('daySelect');
  currentDayIndex = index;
  document.getElementById('daySelectScreen').style.display = 'none';
  document.getElementById('studyScreen').style.display = 'block';
  const dayNum = String(dayData[index].day).padStart(2, '0');
  document.getElementById('headerDayLabel').innerHTML = ` : Day ${dayNum} <span style="font-size:.7em;color:#2c2c3a;-webkit-text-fill-color:#2c2c3a">â–¼</span>`;
  updateDayTitle();
  startStudy();
}

// ëŒì•„ê°€ê¸°
function askGoBack() {
  if (document.getElementById('studyScreen').style.display === 'none') return;
  playSound('settings');
  document.getElementById('confirmOverlay').classList.add('open');
}
function closeConfirm() {
  playSound('nav');
  document.getElementById('confirmOverlay').classList.remove('open');
}
function confirmGoBack() {
  playSound('daySelect');
  closeConfirm();
  savePosition();
  window.speechSynthesis.cancel();
  document.getElementById('headerDayLabel').textContent = '';
  showDaySelectScreen();
}

function goBackToSelect() {
  savePosition();
  window.speechSynthesis.cancel();
  document.getElementById('headerDayLabel').textContent = '';
  showDaySelectScreen();
}

function updateDayTitle() {
  const d = dayData[currentDayIndex];
  const el = document.getElementById('dayTitle');
  if (d.title) {
    const parts = d.title.split('/').map(s => s.trim()).filter(s => s);
    const reEn = /^(-?(?:[a-zA-Z\u00B2\u00B3\u00B9]|\([a-zA-Z0-9]\))[a-zA-Z0-9()\u00B2\u00B3\u00B9-]*(,\s*-?(?:[a-zA-Z]|\([a-zA-Z0-9]\))[a-zA-Z0-9()\u00B2\u00B3\u00B9-]*)*)\s*(.*)/;
    let html = '<div class="day-title-grid">';
    parts.forEach(part => {
      const m = part.match(reEn);
      if (m) {
        html += `<div class="day-title-en">${m[1]}</div><div class="day-title-ko">${m[3]}</div>`;
      } else {
        html += `<div class="day-title-ko" style="grid-column:span 2">${part}</div>`;
      }
    });
    html += '</div>';
    el.innerHTML = html;
    el.style.display = 'block';
  } else {
    el.innerHTML = '';
    el.style.display = 'none';
  }
}

function startStudy() {
  const order = document.getElementById('wordOrder').value;
  let pool = [...dayData[currentDayIndex].words];
  if (order === 'random') pool = shuffle(pool);
  studyWords = pool;
  // ì €ì¥ëœ í•™ìŠµ ìœ„ì¹˜ ë³µì› (100% ì™„ë£Œë©´ ì²˜ìŒë¶€í„°)
  const savedPos = getSavedPosition(dayData[currentDayIndex].day);
  if (savedPos >= studyWords.length - 1) {
    currentIndex = 0;
  } else if (savedPos >= 0) {
    currentIndex = savedPos;
  } else {
    currentIndex = 0;
  }
  showCard();
}

// í•™ìŠµ ìœ„ì¹˜ ì €ì¥/ë³µì›
function getSavedPositions() {
  try { return JSON.parse(localStorage.getItem(storageKey('positions')) || '{}'); } catch { return {}; }
}
function getSavedPosition(dayNum) {
  const positions = getSavedPositions();
  return positions['day' + dayNum] !== undefined ? positions['day' + dayNum] : 0;
}
function savePosition() {
  const positions = getSavedPositions();
  const dayNum = dayData[currentDayIndex].day;
  positions['day' + dayNum] = currentIndex;
  // ë§ˆì§€ë§‰ ë‹¨ì–´ì— ë„ë‹¬í•˜ë©´ ì™„ë£Œ í”Œë˜ê·¸ ì €ì¥
  if (currentIndex >= studyWords.length - 1) {
    const completed = getCompletedDays();
    completed['day' + dayNum] = true;
    localStorage.setItem(storageKey('completed'), JSON.stringify(completed));
  }
  localStorage.setItem(storageKey('positions'), JSON.stringify(positions));
}

function getCompletedDays() {
  try { return JSON.parse(localStorage.getItem(storageKey('completed')) || '{}'); } catch { return {}; }
}
function isDayCompleted(dayNum) {
  return getCompletedDays()['day' + dayNum] === true;
}

function shuffle(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [a[i], a[j]] = [a[j], a[i]]; }
  return a;
}

// â”€â”€ ì¹´ë“œ ë’·ë©´ ì¶”ê°€ ì •ë³´ ë Œë”ë§ â”€â”€
function getCardLayout() {
  return document.getElementById('cardLayout').value || 'scroll';
}

function hasExtras(word) {
  return (word.examples && word.examples.length > 0) ||
         (word.derivatives && word.derivatives.length > 0) ||
         (word.synonyms && word.synonyms.length > 0) ||
         (word.antonyms && word.antonyms.length > 0) ||
         (word.phrases && word.phrases.length > 0);
}

function buildExamplesHtml(word) {
  if (!word.examples || word.examples.length === 0) return '';
  const derivWords = word.derivatives ? word.derivatives.map(d => d.en) : [];
  derivWords.sort((a, b) => b.length - a.length);
  const patterns = [];
  if (derivWords.length > 0) patterns.push('\\b(' + derivWords.join('|') + ')\\b');
  patterns.push('\\b(' + word.en + '\\w*)\\b');
  const pattern = new RegExp(patterns.join('|'), 'gi');
  let h = '';
  word.examples.forEach(ex => {
    const enText = ex.en.replace(/\n/g, '<br>').replace(pattern, '<b>$&</b>');
    h += '<div class="example-item">';
    h += `<div class="example-en">${enText}</div>`;
    h += `<div class="example-ko">${ex.ko.replace(/\n/g, '<br>')}`;
    if (ex.source) h += ` <span class="example-source">${ex.source}</span>`;
    h += '</div></div>';
  });
  return h;
}

function buildDerivativesHtml(word) {
  if (!word.derivatives || word.derivatives.length === 0) return '';
  let h = '';
  word.derivatives.forEach(d => {
    h += `<div class="deriv-item"><span class="deriv-word">${d.en}</span><span class="deriv-pos">${d.pos}</span><span class="deriv-def">${d.defs.map(dd => formatDef(dd)).join(' ')}</span></div>`;
  });
  return h;
}

function buildSynAntHtml(word) {
  if ((!word.synonyms || word.synonyms.length === 0) && (!word.antonyms || word.antonyms.length === 0)) return '';
  let h = '<div class="syn-ant-row">';
  if (word.synonyms) word.synonyms.forEach(s => { h += `<span class="syn-tag"><span class="syn-label">â‰’</span> ${s}</span>`; });
  if (word.antonyms) word.antonyms.forEach(a => { h += `<span class="ant-tag"><span class="ant-label">â†”</span> ${a}</span>`; });
  h += '</div>';
  return h;
}

function buildPhrasesHtml(word) {
  if (!word.phrases || word.phrases.length === 0) return '';
  let h = '';
  word.phrases.forEach(p => {
    h += `<div class="phrase-item"><span class="phrase-en">${p.en}</span> ${p.ko}</div>`;
  });
  return h;
}

function renderExtras(word) {
  const el = document.getElementById('cardExtras');
  if (!hasExtras(word)) { el.innerHTML = ''; return; }

  const layout = getCardLayout();
  const exHtml = buildExamplesHtml(word);
  const derivHtml = buildDerivativesHtml(word);
  const synHtml = buildSynAntHtml(word);
  const phraseHtml = buildPhrasesHtml(word);

  // í‘œì‹œí•  ì„¹ì…˜ ëª©ë¡
  const sections = [];
  if (exHtml) sections.push({ icon: 'ğŸ“', title: 'ì˜ˆë¬¸', html: exHtml });
  if (derivHtml) sections.push({ icon: 'ğŸ”„', title: 'íŒŒìƒì–´', html: derivHtml });
  if (phraseHtml) sections.push({ icon: 'ğŸ“Œ', title: 'ìˆ™ì–´ / í‘œí˜„', html: phraseHtml });
  if (synHtml) sections.push({ icon: 'â†”', title: 'ë™ì˜ì–´ / ë°˜ì˜ì–´', html: synHtml });

  if (sections.length === 0) { el.innerHTML = ''; return; }

  let html = '<div class="extras-divider"></div>';

  if (layout === 'scroll') {
    sections.forEach((sec, i) => {
      if (i > 0) html += '<div class="extras-divider"></div>';
      html += `<div class="extras-section-title">${sec.icon} ${sec.title}</div>${sec.html}`;
    });
  } else if (layout === 'accordion') {
    sections.forEach((sec, i) => {
      html += `<div class="acc-section"><button class="acc-header" onclick="toggleAcc(this)">${sec.icon} ${sec.title} <span class="acc-icon">â–¼</span></button><div class="acc-body">${sec.html}</div></div>`;
    });
  } else if (layout === 'tab') {
    // ì˜ˆë¬¸ì€ í•­ìƒ ë°”ë¡œ í‘œì‹œ
    if (exHtml) {
      html += `<div class="extras-section-title">ğŸ“ ì˜ˆë¬¸</div>${exHtml}`;
    }
    const tabSections = sections.filter(s => s.title !== 'ì˜ˆë¬¸');
    if (tabSections.length > 0) {
      html += '<div class="extras-divider"></div>';
      html += '<div class="extras-tab-bar">';
      tabSections.forEach((sec, i) => {
        html += `<button class="extras-tab-btn${i === 0 ? ' active' : ''}" onclick="switchExtrasTab(${i})">${sec.icon} ${sec.title}</button>`;
      });
      html += '</div>';
      tabSections.forEach((sec, i) => {
        html += `<div class="extras-tab-content${i === 0 ? ' active' : ''}" data-tab-idx="${i}">${sec.html}</div>`;
      });
    }
  }

  el.innerHTML = html;
}

function toggleAcc(header) {
  const body = header.nextElementSibling;
  const isOpen = body.classList.contains('open');
  const card = header.closest('.card-extras');
  card.querySelectorAll('.acc-body.open').forEach(b => { b.classList.remove('open'); b.previousElementSibling.classList.remove('open'); });
  if (!isOpen) { body.classList.add('open'); header.classList.add('open'); }
}

function switchExtrasTab(idx) {
  document.querySelectorAll('.extras-tab-btn').forEach((btn, i) => { btn.classList.toggle('active', i === idx); });
  document.querySelectorAll('.extras-tab-content').forEach(el => { el.classList.toggle('active', parseInt(el.dataset.tabIdx) === idx); });
  updateCardHeight();
}

function updateCardHeight() {
  requestAnimationFrame(() => {
    const inner = document.getElementById('cardFlipInner');
    const back = document.getElementById('cardBack');
    const front = document.getElementById('cardFront');
    if (isFlipped) {
      inner.style.minHeight = back.scrollHeight + 'px';
    } else {
      inner.style.minHeight = '';
    }
  });
}

// ResizeObserver: ì¹´ë“œ ë’·ë©´ í¬ê¸° ë³€í™” ìë™ ê°ì§€
const cardBackObserver = new ResizeObserver(() => {
  if (isFlipped) updateCardHeight();
});
cardBackObserver.observe(document.getElementById('cardBack'));

function showCard() {
  const word = studyWords[currentIndex]; if (!word) return;
  speakCount = 0;
  if (document.getElementById('keepFlip').value !== 'keep') {
    resetFlip();
  }
  document.getElementById('cardFlipInner').style.minHeight = '';

  // ë³„í‘œ ìƒíƒœ
  const starred = isStarred(word.en);
  const starText = starred ? 'â˜…' : 'â˜†';
  const starClass = starred ? 'starred' : '';
  document.getElementById('btnStar').textContent = starText;
  document.getElementById('btnStar').className = 'card-btn' + (starClass ? ' ' + starClass : '');
  document.getElementById('btnStarBack').textContent = starText;
  document.getElementById('btnStarBack').className = 'card-btn' + (starClass ? ' ' + starClass : '');

  // ëœ» HTML ìƒì„±
  let meaningsHtml = '';
  word.meanings.forEach(m => {
    const defsHtml = m.defs.map(d => formatDef(d)).join(' ');
    meaningsHtml += `<div class="meaning-group"><span class="pos-tag">${m.pos}</span> <span class="def-inline">${defsHtml}</span></div>`;
  });

  if (viewMode === 'all') {
    // ì „ì²´ë³´ê¸°: ì•ë©´=ì˜ì–´+IPA+ëœ», ë’·ë©´=ë‹¨ì–´ êµ¬ì¡° ë¶„ì„
    document.getElementById('cardWord').textContent = word.en;
    document.getElementById('cardIpa').textContent = word.ipa || '';
    document.getElementById('cardMeanings').innerHTML = meaningsHtml;
    document.getElementById('cardWordBack').textContent = word.en;
    document.getElementById('cardIpaBack').textContent = '';
    document.getElementById('cardMeaningsBack').innerHTML = '';
    document.getElementById('btnSpeak').style.visibility = 'visible';

    // ì–´ì› ë¶„ì„ ë Œë”ë§
    const etyEl = document.getElementById('cardEtymology');
    if (word.parts && word.parts.length > 0) {
      let partsHtml = '<div class="ety-parts">';
      word.parts.forEach((p, i) => {
        if (i > 0) partsHtml += '<div class="ety-plus">+</div>';
        partsHtml += `<div class="ety-part"><span class="part-text">${p.part}</span><span class="part-mean">${p.mean}</span></div>`;
      });
      partsHtml += '</div>';
      if (word.origin) {
        partsHtml += `<div class="ety-origin">ğŸ’¡ ${word.origin.replace(/\n/g, '<br>')}</div>`;
      }
      etyEl.innerHTML = partsHtml;
      document.getElementById('frontHint').textContent = 'íƒ­í•˜ì—¬ ì–´ì› ë³´ê¸°';
      document.getElementById('backHint').textContent = 'íƒ­í•˜ì—¬ ëŒì•„ê°€ê¸°';
      document.getElementById('cardFlipWrapper').style.cursor = 'pointer';
    } else {
      etyEl.innerHTML = '';
      if (hasExtras(word)) {
        document.getElementById('frontHint').textContent = 'íƒ­í•˜ì—¬ ìƒì„¸ ë³´ê¸°';
        document.getElementById('backHint').textContent = 'íƒ­í•˜ì—¬ ëŒì•„ê°€ê¸°';
        document.getElementById('cardFlipWrapper').style.cursor = 'pointer';
      } else {
        document.getElementById('frontHint').textContent = '';
        document.getElementById('backHint').textContent = '';
        document.getElementById('cardFlipWrapper').style.cursor = 'default';
      }
    }
    renderExtras(word);
  } else if (viewMode === 'en') {
    // ì˜ì–´ë³´ê¸°: ì•ë©´=ì˜ì–´+IPA, ë’·ë©´=ëœ»
    document.getElementById('cardWord').textContent = word.en;
    document.getElementById('cardIpa').textContent = word.ipa || '';
    document.getElementById('cardMeanings').innerHTML = '';
    document.getElementById('frontHint').textContent = 'íƒ­í•˜ì—¬ ëœ» ë³´ê¸°';
    document.getElementById('cardWordBack').textContent = '';
    document.getElementById('cardIpaBack').textContent = '';
    document.getElementById('cardMeaningsBack').innerHTML = meaningsHtml;
    document.getElementById('cardEtymology').innerHTML = '';
    document.getElementById('cardExtras').innerHTML = '';
    document.getElementById('backHint').textContent = 'íƒ­í•˜ì—¬ ëŒì•„ê°€ê¸°';
    document.getElementById('cardFlipWrapper').style.cursor = 'pointer';
    document.getElementById('btnSpeak').style.visibility = 'visible';
  } else if (viewMode === 'kr') {
    // ëœ»ë³´ê¸°: ì•ë©´=ëœ», ë’·ë©´=ì˜ì–´+IPA
    document.getElementById('cardWord').textContent = '';
    document.getElementById('cardIpa').textContent = '';
    document.getElementById('cardMeanings').innerHTML = meaningsHtml;
    document.getElementById('frontHint').textContent = 'íƒ­í•˜ì—¬ ë‹¨ì–´ ë³´ê¸°';
    document.getElementById('cardWordBack').textContent = word.en;
    document.getElementById('cardIpaBack').textContent = word.ipa || '';
    document.getElementById('cardMeaningsBack').innerHTML = '';
    document.getElementById('cardEtymology').innerHTML = '';
    document.getElementById('cardExtras').innerHTML = '';
    document.getElementById('backHint').textContent = 'íƒ­í•˜ì—¬ ëŒì•„ê°€ê¸°';
    document.getElementById('cardFlipWrapper').style.cursor = 'pointer';
    document.getElementById('btnSpeak').style.visibility = 'hidden';
  }

  updateModeButtons();
  document.getElementById('btnFirst').disabled = currentIndex === 0;
  document.getElementById('btnPrev').disabled = currentIndex === 0;
  document.getElementById('btnNext').disabled = currentIndex >= studyWords.length - 1;
  const dayNum = dayData[currentDayIndex].day;
  const wasCompleted = isDayCompleted(dayNum);
  document.getElementById('btnLast').disabled = !wasCompleted || currentIndex >= studyWords.length - 1;
  // í€´ì¦ˆ ë²„íŠ¼: 100% ì™„ë£Œ Dayì—ì„œë§Œ í‘œì‹œ
  document.getElementById('btnQuiz').style.display = wasCompleted ? 'block' : 'none';

  // ë’¤ì§‘íŒ ìƒíƒœ ìœ ì§€ ì‹œ ìƒˆ ì¹´ë“œ ë†’ì´ ì¬ê³„ì‚°
  if (isFlipped) updateCardHeight();
}

function goFirst() { playSound('nav'); currentIndex = 0; showCard(); }
function goPrev() { if (currentIndex > 0) { playSound('nav'); currentIndex--; showCard(); } }
function goNext() {
  if (currentIndex < studyWords.length - 1) {
    playSound('nav');
    currentIndex++;
    if (currentIndex >= studyWords.length - 1) savePosition();
    showCard();
  }
}
function goLast() { playSound('nav'); currentIndex = studyWords.length - 1; savePosition(); showCard(); }

// â”€â”€ í€´ì¦ˆ ì‹œìŠ¤í…œ â”€â”€
let quizMode = '';
let quizQuestions = [];
let quizIndex = 0;
let quizCorrect = 0;
let quizWrongList = [];
let quizAnswered = false;
let quizTimer = null;
let isWrongNoteMode = false;

// â”€â”€ ì˜¤ë‹µ Day ìˆœí™˜ ì¹´ìš´í„° â”€â”€
function getWrongDayIndex() {
  try { return parseInt(localStorage.getItem(storageKey('wrongDayIdx')) || '0', 10); } catch { return 0; }
}
function advanceWrongDayIndex() {
  let idx = getWrongDayIndex() + 1;
  if (idx >= dayData.length) idx = 0;
  localStorage.setItem(storageKey('wrongDayIdx'), String(idx));
}

function startQuiz() {
  playSound('daySelect');
  document.getElementById('studyScreen').style.display = 'none';
  document.getElementById('quizSelectScreen').style.display = 'block';
  document.getElementById('quizScreen').style.display = 'none';
  document.getElementById('quizResultScreen').style.display = 'none';
  document.getElementById('wrongNoteSelectScreen').style.display = 'none';
  // ì˜¤ë‹µë…¸íŠ¸ ê°œìˆ˜ í‘œì‹œ
  const noteCount = getTotalWrongCount();
  document.getElementById('wrongNoteCount').textContent = noteCount > 0 ? `í‹€ë¦° ë‹¨ì–´ ${noteCount}ê°œ ì €ì¥ë¨` : 'í‹€ë¦° ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤';
}

function exitQuiz() {
  playSound('nav');
  document.getElementById('quizSelectScreen').style.display = 'none';
  document.getElementById('quizScreen').style.display = 'none';
  document.getElementById('quizResultScreen').style.display = 'none';
  document.getElementById('wrongNoteSelectScreen').style.display = 'none';
  document.getElementById('studyScreen').style.display = 'block';
}

function exitQuizToDay() {
  playSound('daySelect');
  document.getElementById('quizSelectScreen').style.display = 'none';
  document.getElementById('quizScreen').style.display = 'none';
  document.getElementById('quizResultScreen').style.display = 'none';
  document.getElementById('wrongNoteSelectScreen').style.display = 'none';
  document.getElementById('headerDayLabel').textContent = '';
  showDaySelectScreen();
}

function retryWrongOnly() {
  playSound('daySelect');
  document.getElementById('quizResultScreen').style.display = 'none';
  quizQuestions = shuffle([...quizWrongList]);
  quizIndex = 0;
  quizCorrect = 0;
  quizWrongList = [];
  quizAnswered = false;
  document.getElementById('quizScreen').style.display = 'block';
  showQuizQuestion();
}

// def ë¬¸ìì—´ì—ì„œ ë²ˆí˜¸ì™€ *ë¥¼ ì œê±°í•œ ìˆœìˆ˜ í…ìŠ¤íŠ¸ ë°˜í™˜
function stripDef(d) {
  return d.replace(/^\d+\s*/, '').replace(/\*([^*]*)\*?/g, '$1');
}

// def ë¬¸ìì—´ì„ HTMLë¡œ ë³€í™˜ (ë²ˆí˜¸ + ë¶‰ì€ë³¼ë“œ ì²˜ë¦¬)
function formatDef(d) {
  const numMatch = d.match(/^(\d+)\s+(.*)/);
  if (numMatch) {
    const num = numMatch[1];
    let text = numMatch[2];
    const cls = num === '1' ? '' : 'def-numbered';
    if (text.startsWith('*') && text.indexOf('*', 1) === -1) {
      text = text.substring(1);
      return `<span class="${cls}"><span class="def-num">${num}</span> <span class="def-highlight">${text}</span></span>`;
    }
    text = text.replace(/\*([^*]+)\*/g, '<span class="def-highlight">$1</span>');
    return `<span class="${cls}"><span class="def-num">${num}</span> ${text}</span>`;
  }
  if (d.startsWith('*') && d.indexOf('*', 1) === -1) {
    return `<span class="def-highlight">${d.substring(1)}</span>`;
  }
  const replaced = d.replace(/\*([^*]+)\*/g, '<span class="def-highlight">$1</span>');
  return replaced;
}

// ë‹¨ì–´ì˜ ëª¨ë“  ëœ»ì„ í•˜ë‚˜ì˜ ë¬¸ìì—´ë¡œ ê²°í•©
function getDefsText(word) {
  return word.meanings.map(m => m.defs.map(d => stripDef(d)).join(', ')).join(' / ');
}

// ë‹¨ì–´ì˜ ëª¨ë“  ëœ»ì„ ê°œë³„ ë°°ì—´ë¡œ
function getAllDefs(word) {
  const defs = [];
  word.meanings.forEach(m => m.defs.forEach(d => {
    stripDef(d).split(',').forEach(s => { if (s.trim()) defs.push(s.trim()); });
  }));
  return defs;
}

function expandDefs(defs) {
  const result = [];
  defs.forEach(d => {
    // ë§¨ ì• ê´„í˜¸ëŠ” ë¶€ì—° ì„¤ëª… â†’ ì œê±°ë§Œ
    const leading = d.match(/^[\(\[](.+?)[\)\]]\s*(.+)$/);
    if (leading) {
      result.push(leading[2].trim());
      return;
    }
    // ì¤‘ê°„/ë ê´„í˜¸ëŠ” ëŒ€ì²´ í‘œí˜„ â†’ ë‘ ë³€í˜• ìƒì„±
    const m = d.match(/^(.+?)[\(\[](.+?)[\)\]](.*)$/);
    if (m) {
      const withoutParen = (m[1] + m[3]).trim();
      const withParen = (m[2] + m[3]).trim();
      if (withoutParen) result.push(withoutParen);
      if (withParen) result.push(withParen);
    } else {
      result.push(d);
    }
  });
  return result;
}

// í’ˆì‚¬ ëª©ë¡
function getPosList(word) {
  return word.meanings.map(m => m.pos);
}

// â”€â”€ ì˜¤ë‹µë…¸íŠ¸ ì €ì¥/ê´€ë¦¬ (ëª¨ë“œë³„) â”€â”€
function getWrongNotesAll() {
  try { return JSON.parse(localStorage.getItem(storageKey('wrong_notes')) || '{}'); } catch { return {}; }
}
function saveWrongNotesAll(data) {
  localStorage.setItem(storageKey('wrong_notes'), JSON.stringify(data));
}
function getWrongNotes(mode) {
  const data = getWrongNotesAll();
  return data[mode] || [];
}
function addToWrongNotes(word, mode) {
  const data = getWrongNotesAll();
  if (!data[mode]) data[mode] = [];
  if (!data[mode].some(w => w.en === word.en)) {
    data[mode].push(word);
    saveWrongNotesAll(data);
  }
}
function removeFromWrongNotes(word, mode) {
  const data = getWrongNotesAll();
  if (!data[mode]) return;
  data[mode] = data[mode].filter(w => w.en !== word.en);
  saveWrongNotesAll(data);
}
function getTotalWrongCount() {
  const data = getWrongNotesAll();
  const seen = new Set();
  Object.values(data).forEach(arr => arr.forEach(w => seen.add(w.en)));
  return seen.size;
}

// ì˜¤ë‹µ ì¶”ì¶œ: ê°™ì€ Day ìš°ì„ , ë¶€ì¡±í•˜ë©´ ë‹¤ë¥¸ Dayì—ì„œ ë³´ì¶©
function getWrongChoices(correctWord, count) {
  const wrongDayIdx = getWrongDayIndex();
  const wrongDayWords = dayData[wrongDayIdx] ? dayData[wrongDayIdx].words.filter(w => w.en !== correctWord.en) : [];

  // ê°™ì€ í’ˆì‚¬ ìš°ì„  ì •ë ¬
  const correctPos = getPosList(correctWord);
  const sortByPos = (a, b) => {
    const aMatch = getPosList(a).some(p => correctPos.includes(p)) ? 0 : 1;
    const bMatch = getPosList(b).some(p => correctPos.includes(p)) ? 0 : 1;
    return aMatch - bMatch;
  };

  let pool = shuffle([...wrongDayWords]).sort(sortByPos);

  // ì˜¤ë‹µ Dayì—ì„œ ë¶€ì¡±í•˜ë©´ ì „ì²´ì—ì„œ ë³´ì¶©
  if (pool.length < count) {
    const otherWords = allWords.filter(w => w.en !== correctWord.en && !wrongDayWords.some(wd => wd.en === w.en));
    pool = pool.concat(shuffle([...otherWords]).sort(sortByPos));
  }
  return pool.slice(0, count);
}

// ì˜¤ë‹µë…¸íŠ¸ ì—´ê¸°
function openWrongNoteQuiz() {
  const total = getTotalWrongCount();
  if (total === 0) {
    alert('ì˜¤ë‹µë…¸íŠ¸ì— ì €ì¥ëœ ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  playSound('daySelect');
  updateWrongNoteModeCounts();
  document.getElementById('quizSelectScreen').style.display = 'none';
  document.getElementById('wrongNoteSelectScreen').style.display = 'block';
}

function updateWrongNoteModeCounts() {
  const modes = ['en2kr_mc', 'kr2en_mc', 'en2kr_write', 'kr2en_write'];
  modes.forEach(mode => {
    const count = getWrongNotes(mode).length;
    const el = document.getElementById('wnCount_' + mode);
    if (el) el.textContent = count > 0 ? `${count}ê°œ` : '0ê°œ';
    const btn = document.getElementById('wnBtn_' + mode);
    if (btn) {
      btn.style.opacity = count > 0 ? '1' : '.4';
      btn.style.pointerEvents = count > 0 ? 'auto' : 'none';
    }
  });
}

function closeWrongNoteSelect() {
  playSound('nav');
  document.getElementById('wrongNoteSelectScreen').style.display = 'none';
  document.getElementById('quizSelectScreen').style.display = 'block';
}

// í€´ì¦ˆ ì‹œì‘
function beginQuiz(mode) {
  playSound('daySelect');
  quizMode = mode;
  quizIndex = 0;
  quizCorrect = 0;
  quizWrongList = [];
  quizAnswered = false;
  isWrongNoteMode = false;

  // í˜„ì¬ Day ë‹¨ì–´ë¥¼ ëœë¤ ìˆœì„œë¡œ
  quizQuestions = shuffle([...dayData[currentDayIndex].words]);

  document.getElementById('quizSelectScreen').style.display = 'none';
  document.getElementById('quizResultScreen').style.display = 'none';
  document.getElementById('wrongNoteSelectScreen').style.display = 'none';
  document.getElementById('quizScreen').style.display = 'block';

  showQuizQuestion();
}

// ì˜¤ë‹µë…¸íŠ¸ í€´ì¦ˆ ì‹œì‘
function beginWrongNoteQuiz(mode) {
  const notes = getWrongNotes(mode);
  if (notes.length === 0) return;
  playSound('daySelect');
  quizMode = mode;
  quizIndex = 0;
  quizCorrect = 0;
  quizWrongList = [];
  quizAnswered = false;
  isWrongNoteMode = true;

  quizQuestions = shuffle([...notes]);

  document.getElementById('wrongNoteSelectScreen').style.display = 'none';
  document.getElementById('quizResultScreen').style.display = 'none';
  document.getElementById('quizScreen').style.display = 'block';

  showQuizQuestion();
}

function showQuizQuestion() {
  quizAnswered = false;
  if (quizTimer) { clearTimeout(quizTimer); quizTimer = null; }
  const q = quizQuestions[quizIndex];
  const total = quizQuestions.length;
  const pct = Math.round(((quizIndex) / total) * 100);

  document.getElementById('quizProgressFill').style.width = pct + '%';
  document.getElementById('quizProgressText').textContent = `${quizIndex + 1} / ${total}`;
  document.getElementById('quizFeedback').textContent = '';
  document.getElementById('quizFeedback').className = 'quiz-feedback';
  document.getElementById('quizAnswerReveal').textContent = '';

  const isMultipleChoice = quizMode === 'en2kr_mc' || quizMode === 'kr2en_mc';
  const isEnToKr = quizMode === 'en2kr_mc' || quizMode === 'en2kr_write';

  if (isEnToKr) {
    document.getElementById('quizLabel').textContent = isMultipleChoice ? 'ë‹¤ìŒ ì˜ì–´ ë‹¨ì–´ì˜ ëœ»ì€?' : 'ë‹¤ìŒ ì˜ì–´ ë‹¨ì–´ì˜ ëœ»ì„ ì“°ì„¸ìš”';
    document.getElementById('quizQuestion').textContent = q.en;
    document.getElementById('quizQuestion').className = 'quiz-question en';
    document.getElementById('quizIpa').textContent = q.ipa || '';
  } else {
    document.getElementById('quizLabel').textContent = isMultipleChoice ? 'ë‹¤ìŒ ëœ»ì— í•´ë‹¹í•˜ëŠ” ì˜ì–´ ë‹¨ì–´ëŠ”?' : 'ë‹¤ìŒ ëœ»ì— í•´ë‹¹í•˜ëŠ” ì˜ì–´ ë‹¨ì–´ë¥¼ ì“°ì„¸ìš”';
    document.getElementById('quizQuestion').textContent = getDefsText(q);
    document.getElementById('quizQuestion').className = 'quiz-question kr';
    document.getElementById('quizIpa').textContent = '';
  }

  if (isMultipleChoice) {
    document.getElementById('quizChoices').style.display = 'flex';
    document.getElementById('quizInputWrap').style.display = 'none';
    document.getElementById('quizSubmitBtn').style.display = 'none';
    buildChoices(q, isEnToKr);
  } else {
    document.getElementById('quizChoices').style.display = 'none';
    document.getElementById('quizInputWrap').style.display = 'block';
    document.getElementById('quizSubmitBtn').style.display = 'block';
    document.getElementById('quizSubmitBtn').disabled = false;
    const input = document.getElementById('quizInput');
    input.value = '';
    input.className = 'quiz-input';
    input.placeholder = isEnToKr ? 'í•œêµ­ì–´ ëœ»ì„ ì…ë ¥í•˜ì„¸ìš”' : 'ì˜ì–´ ë‹¨ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”';
    input.focus();
  }
}

function buildChoices(correctWord, isEnToKr) {
  const wrongs = getWrongChoices(correctWord, 3);
  let choices;

  if (isEnToKr) {
    choices = [
      { text: getDefsText(correctWord), correct: true },
      ...wrongs.map(w => ({ text: getDefsText(w), correct: false }))
    ];
  } else {
    choices = [
      { text: correctWord.en, correct: true },
      ...wrongs.map(w => ({ text: w.en, correct: false }))
    ];
  }

  choices = shuffle(choices);

  const container = document.getElementById('quizChoices');
  container.innerHTML = '';
  const labels = ['â‘ ', 'â‘¡', 'â‘¢', 'â‘£'];
  choices.forEach((c, i) => {
    const div = document.createElement('div');
    div.className = 'quiz-choice';
    div.textContent = `${labels[i]} ${c.text}`;
    div.dataset.correct = c.correct;
    div.onclick = function() { selectChoice(this, c.correct, correctWord); };
    container.appendChild(div);
  });
}

function selectChoice(el, isCorrect, correctWord) {
  if (quizAnswered) return;
  quizAnswered = true;
  playSound(isCorrect ? 'star' : 'nav');

  const allChoices = document.querySelectorAll('#quizChoices .quiz-choice');
  allChoices.forEach(c => {
    if (c.dataset.correct === 'true') {
      c.classList.add(isCorrect ? 'correct' : 'reveal');
      if (!isCorrect) c.textContent += ' âœ“';
    } else if (c === el && !isCorrect) {
      c.classList.add('wrong');
    } else {
      c.classList.add('disabled');
    }
  });

  if (isCorrect) {
    quizCorrect++;
    document.getElementById('quizFeedback').textContent = 'âœ… ì •ë‹µì…ë‹ˆë‹¤!';
    document.getElementById('quizFeedback').className = 'quiz-feedback correct';
    if (isWrongNoteMode) removeFromWrongNotes(correctWord, quizMode);
    quizTimer = setTimeout(autoAdvance, 800);
  } else {
    quizWrongList.push(correctWord);
    addToWrongNotes(correctWord, quizMode);
    document.getElementById('quizFeedback').textContent = 'âŒ í‹€ë ¸ìŠµë‹ˆë‹¤';
    document.getElementById('quizFeedback').className = 'quiz-feedback wrong';
    quizTimer = setTimeout(autoAdvance, 2000);
  }
}

function submitWriteAnswer() {
  if (quizAnswered) return;
  const input = document.getElementById('quizInput');
  const answer = input.value.trim();
  if (!answer) return;

  quizAnswered = true;
  const q = quizQuestions[quizIndex];
  const isEnToKr = quizMode === 'en2kr_write';
  let isCorrect = false;

  if (isEnToKr) {
    // í•œêµ­ì–´ ëœ» ë§¤ì¹­: ì…ë ¥ê°’ì´ ëœ» ëª©ë¡ ì¤‘ í•˜ë‚˜ì— í¬í•¨ë˜ë©´ ì •ë‹µ
    const allDefs = expandDefs(getAllDefs(q));
    isCorrect = allDefs.some(d => {
      const norm = s => s.replace(/[\s,.\-()~]/g, '').toLowerCase();
      if (!norm(answer)) return false;
      return norm(answer) === norm(d);
    });
  } else {
    // ì˜ì–´ ë‹¨ì–´ ë§¤ì¹­: ëŒ€ì†Œë¬¸ì ë¬´ì‹œ
    isCorrect = answer.toLowerCase() === q.en.toLowerCase();
  }

  playSound(isCorrect ? 'star' : 'nav');

  if (isCorrect) {
    quizCorrect++;
    input.classList.add('correct');
    document.getElementById('quizFeedback').textContent = 'âœ… ì •ë‹µì…ë‹ˆë‹¤!';
    document.getElementById('quizFeedback').className = 'quiz-feedback correct';
    if (isWrongNoteMode) removeFromWrongNotes(q, quizMode);
    quizTimer = setTimeout(autoAdvance, 800);
  } else {
    quizWrongList.push(q);
    addToWrongNotes(q, quizMode);
    input.classList.add('wrong');
    document.getElementById('quizFeedback').textContent = 'âŒ í‹€ë ¸ìŠµë‹ˆë‹¤';
    document.getElementById('quizFeedback').className = 'quiz-feedback wrong';
    // ì •ë‹µ ë³´ì—¬ì£¼ê¸°
    if (isEnToKr) {
      document.getElementById('quizAnswerReveal').textContent = 'ì •ë‹µ: ' + getDefsText(q);
    } else {
      document.getElementById('quizAnswerReveal').textContent = 'ì •ë‹µ: ' + q.en;
    }
    quizTimer = setTimeout(autoAdvance, 2000);
  }

  document.getElementById('quizSubmitBtn').disabled = true;
}

function autoAdvance() {
  quizTimer = null;
  quizIndex++;
  if (quizIndex >= quizQuestions.length) {
    showQuizResult();
  } else {
    showQuizQuestion();
  }
}

function showQuizResult() {
  advanceWrongDayIndex();
  document.getElementById('quizScreen').style.display = 'none';
  document.getElementById('quizResultScreen').style.display = 'block';

  const total = quizQuestions.length;
  const score = Math.round((quizCorrect / total) * 100);
  const dayNum = String(dayData[currentDayIndex].day).padStart(2, '0');

  let emoji = 'ğŸ‰';
  if (score === 100) emoji = 'ğŸ†';
  else if (score >= 80) emoji = 'ğŸ‰';
  else if (score >= 60) emoji = 'ğŸ˜Š';
  else if (score >= 40) emoji = 'ğŸ˜…';
  else emoji = 'ğŸ’ª';

  document.getElementById('quizResultEmoji').textContent = emoji;
  document.getElementById('quizResultTitle').textContent = isWrongNoteMode ? 'ì˜¤ë‹µë…¸íŠ¸ í€´ì¦ˆ ì™„ë£Œ!' : `Day ${dayNum} í€´ì¦ˆ ì™„ë£Œ!`;
  document.getElementById('quizResultScore').textContent = score + 'ì ';
  document.getElementById('quizResultSub').textContent = `${total}ë¬¸ì œ ì¤‘ ${quizCorrect}ë¬¸ì œ ì •ë‹µ`;

  if (quizWrongList.length > 0) {
    document.getElementById('quizResultWrong').style.display = 'block';
    document.getElementById('quizResultWrongTitle').textContent = `âŒ í‹€ë¦° ë‹¨ì–´ (${quizWrongList.length}ê°œ)`;
    let html = '';
    quizWrongList.forEach(w => {
      html += `<div class="quiz-wrong-item"><span class="en">${w.en}</span><span class="kr">${getDefsText(w)}</span></div>`;
    });
    document.getElementById('quizResultWrongList').innerHTML = html;
    document.getElementById('btnRetryWrong').style.display = 'block';
  } else {
    document.getElementById('quizResultWrong').style.display = 'none';
    document.getElementById('btnRetryWrong').style.display = 'none';
  }

  playSound(score === 100 ? 'star' : 'daySelect');
}

// ì£¼ê´€ì‹ Enter í‚¤ ì œì¶œ
document.addEventListener('keydown', function(e) {
  if (document.getElementById('quizScreen').style.display !== 'none' && document.getElementById('quizInputWrap').style.display !== 'none') {
    if (e.key === 'Enter' && !quizAnswered) {
      e.preventDefault();
      submitWriteAnswer();
    }
  }
});

function toggleFullscreen() {
  playSound('settings');
  if (!document.fullscreenElement) {
    document.documentElement.requestFullscreen().then(() => {
      document.body.classList.add('fullscreen-mode');
      document.getElementById('btnFullscreen').textContent = 'ğŸ–¥ï¸ ì „ì²´í™”ë©´ í•´ì œ';
    }).catch(() => {});
  } else {
    document.exitFullscreen().then(() => {
      document.body.classList.remove('fullscreen-mode');
      document.getElementById('btnFullscreen').textContent = 'ğŸ–¥ï¸ ì „ì²´í™”ë©´ ëª¨ë“œ';
    }).catch(() => {});
  }
}
document.addEventListener('fullscreenchange', function() {
  if (!document.fullscreenElement) {
    document.body.classList.remove('fullscreen-mode');
    document.getElementById('btnFullscreen').textContent = 'ğŸ–¥ï¸ ì „ì²´í™”ë©´ ëª¨ë“œ';
  }
});

function toggleSettings() { playSound('settings'); document.getElementById('settingsPanel').classList.toggle('open'); }
function closeSettings() { playSound('nav'); document.getElementById('settingsPanel').classList.remove('open'); }
document.getElementById('settingsPanel').addEventListener('click', function(e) { if (e.target === this) closeSettings(); });

// ë“œë¡­ë‹¤ìš´ ë³€ê²½ ì‹œ ì†Œë¦¬
document.getElementById('wordOrder').addEventListener('change', function() { playSound('mode'); saveSettings(); });
document.getElementById('voiceSelect').addEventListener('change', function() { playSound('mode'); saveSettings(); });
document.getElementById('slowSpeed').addEventListener('change', function() { playSound('mode'); saveSettings(); });
document.getElementById('cardLayout').addEventListener('change', function() { playSound('mode'); saveSettings(); if (document.getElementById('studyScreen').style.display !== 'none') showCard(); });
document.getElementById('keepFlip').addEventListener('change', function() { playSound('mode'); saveSettings(); });

document.addEventListener('keydown', function(e) {
  if (document.getElementById('settingsPanel').classList.contains('open')) return;
  if (document.getElementById('studyScreen').style.display === 'none') return;
  if (e.key === 'ArrowLeft') goPrev();
  if (e.key === 'ArrowRight') goNext();
  if (e.key === 'Home') goFirst();
  if (e.key === 'End') goLast();
  if (e.key === ' ') { e.preventDefault(); speakWord(null); }
  if (e.key === 'Escape' || e.key === 'Backspace') askGoBack();
});

appInit();
</script>
</body>
</html>
